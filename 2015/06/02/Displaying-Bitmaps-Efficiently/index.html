
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Displaying Bitmaps Efficiently | louis.chen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="louis.chen">
    

    
    <meta name="description" content="本篇学习下处理和加载Bitmap对象的方法，对于处理和加载Bitmap，如果不注意，会导致出现下面的错误:java.lang.OutofMemoryError: bitmap size exceeds VM budget.下面是几个原因需要关注的：

Android设备分配给每个程序的资源空间有限
Bitmaps很占内存
Android的app频繁的一次性加载很多图片">
<meta property="og:type" content="article">
<meta property="og:title" content="Displaying Bitmaps Efficiently">
<meta property="og:url" content="http://chenfuduo.me/2015/06/02/Displaying-Bitmaps-Efficiently/index.html">
<meta property="og:site_name" content="louis.chen">
<meta property="og:description" content="本篇学习下处理和加载Bitmap对象的方法，对于处理和加载Bitmap，如果不注意，会导致出现下面的错误:java.lang.OutofMemoryError: bitmap size exceeds VM budget.下面是几个原因需要关注的：

Android设备分配给每个程序的资源空间有限
Bitmaps很占内存
Android的app频繁的一次性加载很多图片">
<meta property="og:image" content="http://1.infotravel.sinaapp.com/pic/4.gif">
<meta property="og:image" content="http://1.infotravel.sinaapp.com/pic/1.PNG">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Displaying Bitmaps Efficiently">
<meta name="twitter:description" content="本篇学习下处理和加载Bitmap对象的方法，对于处理和加载Bitmap，如果不注意，会导致出现下面的错误:java.lang.OutofMemoryError: bitmap size exceeds VM budget.下面是几个原因需要关注的：

Android设备分配给每个程序的资源空间有限
Bitmaps很占内存
Android的app频繁的一次性加载很多图片">

    
    <link rel="alternative" href="/atom.xml" title="louis.chen" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="louis.chen" title="louis.chen"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="louis.chen">louis.chen</a></h1>
				<h2 class="blog-motto">纸上得来终觉浅,绝知此事要躬行。</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/project">项目</a></li>
					
						<li><a href="/about">资源</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:chenfuduo.me">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/06/02/Displaying-Bitmaps-Efficiently/" title="Displaying Bitmaps Efficiently" itemprop="url">Displaying Bitmaps Efficiently</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="louis.chen" target="_blank" itemprop="author">louis.chen</a>
		
  <p class="article-time">
    <time datetime="2015-06-02T11:52:58.000Z" itemprop="datePublished"> 发表于 2015-06-02</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#有效加载大位图"><span class="toc-number">1.</span> <span class="toc-text">有效加载大位图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#读取位图的尺寸和类型"><span class="toc-number">1.1.</span> <span class="toc-text">读取位图的尺寸和类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载缩小版本到内存"><span class="toc-number">1.2.</span> <span class="toc-text">加载缩小版本到内存</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#在UI线程之外处理位图"><span class="toc-number">2.</span> <span class="toc-text">在UI线程之外处理位图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用AsyncTask"><span class="toc-number">2.1.</span> <span class="toc-text">使用AsyncTask</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#处理并发"><span class="toc-number">2.2.</span> <span class="toc-text">处理并发</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#阶段案例总结"><span class="toc-number">3.</span> <span class="toc-text">阶段案例总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#总体分析"><span class="toc-number">3.1.</span> <span class="toc-text">总体分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#缓存位图"><span class="toc-number">4.</span> <span class="toc-text">缓存位图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用内存缓存"><span class="toc-number">4.1.</span> <span class="toc-text">使用内存缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用硬盘缓存"><span class="toc-number">4.2.</span> <span class="toc-text">使用硬盘缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#处理配置的改变"><span class="toc-number">4.3.</span> <span class="toc-text">处理配置的改变</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#管理位图的内存"><span class="toc-number">5.</span> <span class="toc-text">管理位图的内存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#管理Android2-3-3或者更低的版本"><span class="toc-number">5.1.</span> <span class="toc-text">管理Android2.3.3或者更低的版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#管理Android3-0或者更高的版本"><span class="toc-number">5.2.</span> <span class="toc-text">管理Android3.0或者更高的版本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Displaying_Bitmaps_in_Your_UI"><span class="toc-number">6.</span> <span class="toc-text">Displaying Bitmaps in Your UI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#加载到ViewPager上"><span class="toc-number">6.1.</span> <span class="toc-text">加载到ViewPager上</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载数据到GridView上"><span class="toc-number">6.2.</span> <span class="toc-text">加载数据到GridView上</span></a></li></ol></li></ol>
		
		</div>
		
		<p>本篇学习下处理和加载<code>Bitmap</code>对象的方法，对于处理和加载<code>Bitmap</code>，如果不注意，会导致出现下面的错误:<br><code>java.lang.OutofMemoryError: bitmap size exceeds VM budget.</code><br>下面是几个原因需要关注的：</p>
<ul>
<li>Android设备分配给每个程序的资源空间有限</li>
<li>Bitmaps很占内存</li>
<li>Android的app频繁的一次性加载很多图片<a id="more"></a>
<h1 id="有效加载大位图">有效加载大位图</h1>通过加载小的二次取样的位图版本来解析大的位图。(decoding large bitmaps without exceeding the per application memory limit by loading a smaller subsampled version in memory.)<h2 id="读取位图的尺寸和类型">读取位图的尺寸和类型</h2><code>BitmapFactory</code>类提供了几种创建Bitmap位图的解析方法: (<code>decodeByteArray(), decodeFile(), decodeResource()</code>, etc.),这些方法试图为构造位图去分配内存，因此很容易导致<code>OutOfMemory</code>的异常。每种类型的解码方法都有附加的签名让你去指定解析的选项(decoding options)。这些是通过<code>BitmapFactory.Options</code>这个类的。将<code>inJustDecodeBounds</code>属性设置为true可以避免解析过程中的内存分配。这个技巧可以让我们先读取位图的类型和尺寸，再去构建(分配内存)位图。<br>为了避免OOM，解析位图之前先得到他的尺寸和类型。<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">      options.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">      BitmapFactory.decodeResource(getResources(),R.id.imageView,options);</span><br><span class="line">      <span class="keyword">int</span> outHeight = options.outHeight;</span><br><span class="line">      <span class="keyword">int</span> outWidth = options.outWidth;</span><br><span class="line">      String outMimeType = options.outMimeType;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="加载缩小版本到内存">加载缩小版本到内存</h2><p>上面的步骤得到了图片的尺寸，它们可以用来决定是否整个图片应该被加载到内存还是二次取样的版本，下面是需要考虑的一些因素。</p>
<ul>
<li>预估整个图片加载到内存中需要的内存大小</li>
<li>这个图片你想分配给它多大的内存以及你的程序中其他的对内存的需求</li>
<li>这个图片将要被加载进去的目标ImageView或者UI组件的尺寸。<br>解码器二次取样图片加载小的版本到内存中，需要将<code>BitmapFactory.Options</code>的<code>inSampleSize</code>设置为true。举个例子，一副分辨率为2048<em>1536的图片按照<code>inSampleSize</code>为4最终解析为512</em>384.原来需要12M,现在需要0.75M。下面的方法计算取样的值(基于2为底)<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculateInSampleSize</span><span class="params">(BitmapFactory.Options options, <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> outHeight = options.outHeight;</span><br><span class="line">       <span class="keyword">int</span> outWidth = options.outWidth;</span><br><span class="line">       <span class="keyword">int</span> inSampleSize = <span class="number">1</span>;</span><br><span class="line">       <span class="keyword">if</span> (outHeight &gt; reqHeight || outWidth &gt; reqWidth) &#123;</span><br><span class="line">           <span class="keyword">int</span> halfHeight = outHeight / <span class="number">2</span>;</span><br><span class="line">           <span class="keyword">int</span> halfWidth = outWidth / <span class="number">2</span>;</span><br><span class="line">           <span class="keyword">while</span> ((halfHeight / inSampleSize) &gt; reqHeight &amp;&amp; (halfWidth / inSampleSize) &gt; reqWidth) &#123;</span><br><span class="line">               inSampleSize *= <span class="number">2</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> inSampleSize;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Note: A power of two value is calculated because the decoder uses a final value by rounding down to the nearest power of two, as per the inSampleSize documentation.<br>使用上面的方法，首先需要<code>options.inJustDecodeBounds = true;</code><br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeSampledBitmapFromResource</span><span class="params">(Resources res,<span class="keyword">int</span> resId,<span class="keyword">int</span> reqWidth,<span class="keyword">int</span> reqHeight)</span></span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">        BitmapFactory.decodeResource(res,resId,options);</span><br><span class="line">        options.inSampleSize = calculateInSampleSize(options,reqWidth,reqHeight);</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span>  BitmapFactory.decodeResource(res,resId,options);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>设置：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ImageView imageView = (ImageView) findViewById(R.id.imageView);</span><br><span class="line">       imageView.setImageBitmap(decodeSampledBitmapFromResource(getResources(),R.id.imageView,<span class="number">100</span>,<span class="number">100</span>));</span><br></pre></td></tr></table></figure></p>
<p>完整的代码：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.Menu;</span><br><span class="line"><span class="keyword">import</span> android.view.MenuItem;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ImageView imageView = (ImageView) findViewById(R.id.imageView);</span><br><span class="line">        imageView.setImageBitmap(decodeSampledBitmapFromResource(<span class="number">100</span>, <span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculateInSampleSize</span><span class="params">(BitmapFactory.Options options, <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> outHeight = options.outHeight;</span><br><span class="line">        <span class="keyword">int</span> outWidth = options.outWidth;</span><br><span class="line">        String outMimeType = options.outMimeType;</span><br><span class="line">        Log.e(<span class="string">"Test"</span>, <span class="string">"outMimeType:"</span> + outMimeType + <span class="string">"  outWidth:"</span> + outWidth + <span class="string">"  outHeight:"</span> + outHeight);</span><br><span class="line">        <span class="keyword">int</span> inSampleSize = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (outHeight &gt; reqHeight || outWidth &gt; reqWidth) &#123;</span><br><span class="line">            <span class="keyword">int</span> halfHeight = outHeight / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">int</span> halfWidth = outWidth / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">while</span> ((halfHeight / inSampleSize) &gt; reqHeight &amp;&amp; (halfWidth / inSampleSize) &gt; reqWidth) &#123;</span><br><span class="line">                inSampleSize *= <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inSampleSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeSampledBitmapFromResource</span><span class="params">(<span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">        BitmapFactory.decodeFile(<span class="string">"/mnt/sdcard/mnt/sdcard/test.jpg"</span>, options);</span><br><span class="line">        options.inSampleSize = calculateInSampleSize(options, reqWidth, reqHeight);</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> BitmapFactory.decodeFile(<span class="string">"/mnt/sdcard/mnt/sdcard/test.jpg"</span>, options);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Inflate the menu; this adds items to the action bar if it is present.</span></span><br><span class="line">        getMenuInflater().inflate(R.menu.menu_main, menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Handle action bar item clicks here. The action bar will</span></span><br><span class="line">        <span class="comment">// automatically handle clicks on the Home/Up button, so long</span></span><br><span class="line">        <span class="comment">// as you specify a parent activity in AndroidManifest.xml.</span></span><br><span class="line">        <span class="keyword">int</span> id = item.getItemId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">        <span class="keyword">if</span> (id == R.id.action_settings) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>打印出的log:<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">06-02 23:02:57.293  25569-25569/? E/Test﹕ outMimeType:image/jpeg  outWidth:3200  outHeight:1800</span><br><span class="line">06-02 23:03:36.078  25937-25937/? E/Test﹕ outMimeType:image/jpeg  outWidth:3200  outHeight:1800</span><br></pre></td></tr></table></figure></p>
<p>今晚到这里，明天继续。2015-06-02</p>
<h1 id="在UI线程之外处理位图">在UI线程之外处理位图</h1><p>上面说了<code>BitmapFactory.decode*</code>的方法，如果数据源是从硬盘或者网络(除了内存的其他数据源)读取，那么这个操作不应该在主线程执行。加载过程的时间是不可预知的，这些因素包括从网络或者硬盘读取的速度，图片的大小，cpu的性能等等。如果这些有一个阻塞了UI线程。系统就会认为你的程序无响应。本篇将使用AsyncTask在后台处理Bitmaps.并展示如何如理并发(concurrency)的情形。</p>
<h2 id="使用AsyncTask">使用AsyncTask</h2><p><code>AsyncTask</code>提供了在后台执行任务，将结果提交给UI线程的功能。下面的代码演示了具体的操作：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapWorkerTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">String</span>,<span class="title">Void</span>,<span class="title">Bitmap</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;ImageView&gt; imageViewReference;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> String data;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">BitmapWorkerTask</span><span class="params">(ImageView imageView)</span> </span>&#123;</span><br><span class="line">           <span class="comment">//使用WeakReference来保证ImageView可以被垃圾回收</span></span><br><span class="line">           imageViewReference = <span class="keyword">new</span> WeakReference&lt;ImageView&gt;(imageView);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="annotation">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> Bitmap <span class="title">doInBackground</span><span class="params">(String... params)</span> </span>&#123;</span><br><span class="line">           data = params[<span class="number">0</span>];</span><br><span class="line">           <span class="keyword">return</span> decodeSampledBitmapFromResource(<span class="number">100</span>,<span class="number">100</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="annotation">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (imageViewReference != <span class="keyword">null</span> &amp;&amp; bitmap != <span class="keyword">null</span>)&#123;</span><br><span class="line">               ImageView imageView = imageViewReference.get();</span><br><span class="line">               <span class="keyword">if</span> (imageView != <span class="keyword">null</span>)&#123;</span><br><span class="line">                   imageView.setImageBitmap(bitmap);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>使用，加载方法：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBitmap</span><span class="params">(ImageView imageView)</span></span>&#123;</span><br><span class="line">       BitmapWorkerTask task = <span class="keyword">new</span> BitmapWorkerTask(imageView);</span><br><span class="line">       task.execute(<span class="string">"/mnt/sdcard/mnt/sdcard/test.jpg"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>ImageView使用:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ImageView imageView = (ImageView) findViewById(R.id.imageView);</span><br><span class="line">       loadBitmap(imageView);</span><br></pre></td></tr></table></figure></p>
<p>附加一个，手机在wifi下的调试，每次都去插数据线太麻烦了，在wifi下，用wifi连接adb调试是很好的选择。<br>第一步:adb devices<br>列出当前的设备<br>第二步:adb tcpip 5555<br>在tcp/ip模式下重启adb守护进程，然后监听5555端口(adb的默认端口)<br>第三步:adb connect 192.168.1.104<br>ip地址的查看，打开手机设置—-wifi—-高级，在下面既可以看到ip地址。<br>这样拔掉数据线，再去执行adb devices，就可以看到当前的设备已经连接上了。<br>言归正传，上面的WeakReference保证了AsyncTask不去阻碍ImageView和它引用的对象被回收。在task结束后，我们不能保证ImageView是否还存在，所以需要去检查一下(在onPostExecute里检查)，举个例子，如果在task的任务结束前，用户的手机配置发生了改变(屏幕旋转)或者用户导航离开了当前的Activity，那么ImageView在这种情形下，可能不存在。</p>
<h2 id="处理并发">处理并发</h2><p>常用的控件ListView和GridView在使用上面介绍的AsyncTask的时候，带来另外一个问题。这些控件为了内存的效率，当用户滚动的时候，会复用子views。如果每一个子view出发一个AsyncTask,当task完成的时候，不能保证与之关联的view是否被其他的子view所复用。更进一步，不能保证异步任务开始的顺序就是他们完成的顺序。<br>在介绍处理并发的时候，提到了<a href="http://blog.csdn.net/icephone/article/details/7517865" target="_blank" rel="external">一篇博客</a>，<a href="http://blog.csdn.net/zhangyadick18/article/details/6934950" target="_blank" rel="external">英文版的这哥们复制了一份</a>原链接访问不了啊。在这个博客当中，他提出的解决方法是：<br>This is not an issue if the images you download are bound once and for all to given ImageViews；<br>To solve this issue, we should remember the order of the downloads, so that the last started one is the one that will effectively be displayed. It is indeed sufficient for each ImageView to remember its last download. We will add this extra information in the ImageView using a dedicated Drawable subclass, which will be temporarily bind to the ImageView while the download is in progress.<br>大致的意思是：<br>下载的图片只被绑定一次，并且都被指定唯一的imageview；<br>记录下载的次序，保证最后一次启动请求的图片被有效地展现出来。事实上可以实现让每一个ImageView记录它最后一次的下载。我们将会为ImageView添加一个额外的信息，通过使用自定义的Drawable的子类。它将会在下载过程中临时绑定给ImageView。<br>在本篇中，ImageView存储了最近的AsyncTask的引用,当任务结束后，可以检查。<a href="ImageView stores a reference to the most recent AsyncTask which can later be checked when the task complete">翻译的好苦涩，看原版英语吧</a>。<br>注意下面的代码使用了WeakReference来限制对象间的相互依赖。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncDrawable</span> <span class="keyword">extends</span> <span class="title">BitmapDrawable</span></span>&#123;</span><br><span class="line">       WeakReference&lt;BitmapWorkerTask&gt; bitmapWorkerTaskWeakReference;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">AsyncDrawable</span><span class="params">(Resources res, Bitmap bitmap, BitmapWorkerTask bitmapWorkerTask)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">super</span>(res, bitmap);</span><br><span class="line">           bitmapWorkerTaskWeakReference = <span class="keyword">new</span> WeakReference&lt;BitmapWorkerTask&gt;(bitmapWorkerTask);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> BitmapWorkerTask <span class="title">getBitmapWorkerTask</span><span class="params">()</span></span>&#123;</span><br><span class="line">           <span class="keyword">return</span> bitmapWorkerTaskWeakReference.get();</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>使用<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBitmap</span><span class="params">(String data, ImageView imageView)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (cancelPotentialWork(data, imageView)) &#123;</span><br><span class="line">           BitmapWorkerTask task = <span class="keyword">new</span> BitmapWorkerTask(imageView);</span><br><span class="line"></span><br><span class="line">           mLoadingBitmap = getmLoadingBitmap();</span><br><span class="line"></span><br><span class="line">           AsyncDrawable asyncDrawable = <span class="keyword">new</span> AsyncDrawable(getResources(), mLoadingBitmap, task);</span><br><span class="line"></span><br><span class="line">           imageView.setImageDrawable(asyncDrawable);</span><br><span class="line"></span><br><span class="line">           task.execute(<span class="string">"/mnt/sdcard/mnt/sdcard/test.jpg"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>cancelPotentialWork</code>检查与ImageView关联的task.<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">cancelPotentialWork</span><span class="params">(String data, ImageView imageView)</span> </span>&#123;</span><br><span class="line">       BitmapWorkerTask bitmapWorkTask = getBitmapWorkTask(imageView);</span><br><span class="line">       <span class="keyword">if</span> (bitmapWorkTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> String bitmapData = bitmapWorkTask.data;</span><br><span class="line">           <span class="comment">//如果bitmapData没有设置，或者与新的data不同</span></span><br><span class="line">           <span class="keyword">if</span> (bitmapData == <span class="keyword">null</span> || bitmapData != data) &#123;</span><br><span class="line">               <span class="comment">//取消之前的任务</span></span><br><span class="line">               bitmapWorkTask.cancel(<span class="keyword">true</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//ImageView没有关联的任务，或者是存在的任务被取消</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>getBitmapWorkTask()</code>方法<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="javadoc">/**</span><br><span class="line">     * 检索与ImageView关联的task</span><br><span class="line">     *</span><br><span class="line">     *<span class="javadoctag"> @param</span> imageView</span><br><span class="line">     *<span class="javadoctag"> @return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitmapWorkerTask <span class="title">getBitmapWorkTask</span><span class="params">(ImageView imageView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Drawable drawable = imageView.getDrawable();</span><br><span class="line">            <span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> AsyncDrawable) &#123;</span><br><span class="line">                <span class="keyword">final</span> AsyncDrawable asyncDrawable = (AsyncDrawable) drawable;</span><br><span class="line">                <span class="keyword">return</span> asyncDrawable.getBitmapWorkerTask();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>接着<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">if</span> (isCancelled())&#123;</span><br><span class="line">               bitmap = <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">if</span> (imageViewReference != <span class="keyword">null</span> &amp;&amp; bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">               ImageView imageView = imageViewReference.get();</span><br><span class="line">               BitmapWorkerTask bitmapWorkTask = getBitmapWorkTask(imageView);</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">this</span> == bitmapWorkTask &amp;&amp; imageView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   imageView.setImageBitmap(bitmap);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的方法尤其适用于ListView和GridView。<br>这样的话，并发带来的问题我们也就解决了。下面的案例是综合上面的两个部分，将图片展示在ListView上。</p>
<h1 id="阶段案例总结">阶段案例总结</h1><h2 id="总体分析">总体分析</h2><p>运行的效果图如下：<br><img src="http://1.infotravel.sinaapp.com/pic/4.gif" alt="1"><br>下面是程序的框架：<br><img src="http://1.infotravel.sinaapp.com/pic/1.PNG" alt="2"><br>其中<code>ImageWorker</code>是抽象类，封装了加载图片的耗时的操作；<code>ImageResizer</code>类继承自ImageWorker，它的功能是根据给定目标的宽度和高度来重新调整图片的宽度和高度。<code>ImageFetcher</code>是ImageResizer的子类，它的功能是根据URL得到图片并重新调整它们的大小。<code>RecyclingBitmapDrawable</code>后面作介绍，Adapter是ListView的Adapter。<br>先看<code>ImageWork</code>的代码：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.Resources;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.BitmapDrawable;</span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.Drawable;</span><br><span class="line"><span class="keyword">import</span> android.os.AsyncTask;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"></span><br><span class="line"><span class="javadoc">/**</span><br><span class="line"> * Created by Administrator on 2015/6/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageWorker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Bitmap mLoadingBitmap;</span><br><span class="line">    <span class="keyword">protected</span> Resources mResources;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ImageWorker</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mResources = context.getResources();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadImage</span><span class="params">(Object data, ImageView imageView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        BitmapDrawable value = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">            imageView.setImageDrawable(value);</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span><span class="params">(cancelPotentialWork(data, imageView)</span>) </span>&#123;</span><br><span class="line">            BitmapWorkerTask task = <span class="keyword">new</span> BitmapWorkerTask(data, imageView);</span><br><span class="line">            AsyncDrawable asyncDrawable = <span class="keyword">new</span> AsyncDrawable(mResources, mLoadingBitmap, task);</span><br><span class="line">            imageView.setImageDrawable(asyncDrawable);</span><br><span class="line"></span><br><span class="line">            task.execute();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setmLoadingBitmap</span><span class="params">(Bitmap mLoadingBitmap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mLoadingBitmap = mLoadingBitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setmLoadingBitmap</span><span class="params">(<span class="keyword">int</span> resId)</span> </span>&#123;</span><br><span class="line">        mLoadingBitmap = BitmapFactory.decodeResource(mResources, resId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Bitmap <span class="title">processBitmap</span><span class="params">(Object data)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">cancelPotentialWork</span><span class="params">(Object data, ImageView imageView)</span> </span>&#123;</span><br><span class="line">        BitmapWorkerTask bitmapWorkTask = getBitmapWorkTask(imageView);</span><br><span class="line">        <span class="keyword">if</span> (bitmapWorkTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> Object bitmapData = bitmapWorkTask.mData;</span><br><span class="line">            <span class="comment">//如果bitmapData没有设置，或者与新的data不同</span></span><br><span class="line">            <span class="keyword">if</span> (bitmapData == <span class="keyword">null</span> || !bitmapData.equals(data)) &#123;</span><br><span class="line">                <span class="comment">//取消之前的任务</span></span><br><span class="line">                bitmapWorkTask.cancel(<span class="keyword">true</span>);</span><br><span class="line">                Log.e(<span class="string">"Test"</span>, <span class="string">"cancelPotentialWork----cancelled work for "</span> + data);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//the same work is already in progress</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ImageView没有关联的任务，或者是存在的任务被取消</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BitmapWorkerTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Void</span>, <span class="title">Void</span>, <span class="title">BitmapDrawable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;ImageView&gt; imageViewReference;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Object mData;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BitmapWorkerTask</span><span class="params">(Object data, ImageView imageView)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.mData = data;</span><br><span class="line">            <span class="comment">//使用WeakReference来保证ImageView可以被垃圾回收</span></span><br><span class="line">            imageViewReference = <span class="keyword">new</span> WeakReference&lt;ImageView&gt;(imageView);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> BitmapDrawable <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">            Log.d(<span class="string">"Test"</span>, <span class="string">"doInBackground----starting work"</span>);</span><br><span class="line">            Bitmap bitmap = <span class="keyword">null</span>;</span><br><span class="line">            BitmapDrawable drawable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bitmap == <span class="keyword">null</span> &amp;&amp; !isCancelled() &amp;&amp; getAttachedImageView() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                bitmap = processBitmap(mData);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Utils.hasHoneycomb()) &#123;</span><br><span class="line">                    drawable = <span class="keyword">new</span> BitmapDrawable(mResources, bitmap);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    drawable = <span class="keyword">new</span> RecyclingBitmapDrawable(mResources, bitmap);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(<span class="string">"Test"</span>, <span class="string">"doInBackground----finish work"</span>);</span><br><span class="line">            <span class="keyword">return</span> drawable;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(BitmapDrawable value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                value = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ImageView imageView = getAttachedImageView();</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; imageView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Log.d(<span class="string">"Test"</span>, <span class="string">"onPostExecute----setting bitmap"</span>);</span><br><span class="line">                setImageDrawable(imageView, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCancelled</span><span class="params">(BitmapDrawable bitmapDrawable)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.onCancelled(bitmapDrawable);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="javadoc">/**</span><br><span class="line">         * Returns the ImageView associated with this task as long as the ImageView's task still</span><br><span class="line">         * points to this task as well as.Returns null otherwise.</span><br><span class="line">         *</span><br><span class="line">         *<span class="javadoctag"> @return</span></span><br><span class="line">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> ImageView <span class="title">getAttachedImageView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> ImageView imageView = imageViewReference.get();</span><br><span class="line">            BitmapWorkerTask bitmapWorkTask = getBitmapWorkTask(imageView);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == bitmapWorkTask) &#123;</span><br><span class="line">                <span class="keyword">return</span> imageView;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setImageDrawable</span><span class="params">(ImageView imageView, BitmapDrawable drawable)</span> </span>&#123;</span><br><span class="line">        imageView.setImageDrawable(drawable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitmapWorkerTask <span class="title">getBitmapWorkTask</span><span class="params">(ImageView imageView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Drawable drawable = imageView.getDrawable();</span><br><span class="line">            <span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> AsyncDrawable) &#123;</span><br><span class="line">                <span class="keyword">final</span> AsyncDrawable asyncDrawable = (AsyncDrawable) drawable;</span><br><span class="line">                <span class="keyword">return</span> asyncDrawable.getBitmapWorkerTask();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">AsyncDrawable</span> <span class="keyword">extends</span> <span class="title">BitmapDrawable</span> </span>&#123;</span><br><span class="line">        WeakReference&lt;BitmapWorkerTask&gt; bitmapWorkerTaskWeakReference;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncDrawable</span><span class="params">(Resources res, Bitmap bitmap, BitmapWorkerTask bitmapWorkerTask)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(res, bitmap);</span><br><span class="line">            bitmapWorkerTaskWeakReference = <span class="keyword">new</span> WeakReference&lt;&gt;(bitmapWorkerTask);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> BitmapWorkerTask <span class="title">getBitmapWorkerTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> bitmapWorkerTaskWeakReference.get();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>loadImage(Object data, ImageView imageView)</code>根据URL加载图片。</li>
<li><code>public void setmLoadingBitmap(int resId)</code>是记载默认的图片，默认显示这个图片。</li>
<li><code>boolean cancelPotentialWork(Object data, ImageView imageView)</code>这个在前面已经说过了。检查与ImageView关联的task.如果ImageView没有关联的任务，或者是存在的任务被取消，那么返回true。</li>
<li><code>BitmapWorkerTask</code>类异步加载图片。其中里面的<code>getAttachedImageView()</code>方法返回与ImageView的task关联的ImageView。<br>这些内容在前面已经说过了，主要用来处理并发的问题。<br>ImageResizer类：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.Resources;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="javadoc">/**</span><br><span class="line"> * Created by Administrator on 2015/6/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageResizer</span> <span class="keyword">extends</span> <span class="title">ImageWorker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> mImageWidth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> mImageHeight;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ImageResizer</span><span class="params">(Context context,<span class="keyword">int</span> imageWidth,<span class="keyword">int</span> imageHeight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        setImageSize(imageWidth,imageHeight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ImageResizer</span><span class="params">(Context context,<span class="keyword">int</span> imageSize)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        setImageSize(imageSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setImageSize</span><span class="params">(<span class="keyword">int</span> imageSize)</span> </span>&#123;</span><br><span class="line">        setImageSize(imageSize,imageSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setImageSize</span><span class="params">(<span class="keyword">int</span> imageWidth, <span class="keyword">int</span> imageHeight)</span> </span>&#123;</span><br><span class="line">        mImageWidth = imageWidth;</span><br><span class="line">        mImageHeight = imageHeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Bitmap <span class="title">processBitmap</span><span class="params">(<span class="keyword">int</span> resId)</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">"Test"</span>,<span class="string">"processBitmap---"</span> + resId);</span><br><span class="line">        <span class="keyword">return</span> decodeSampledBitmapFromResource(mResources,resId,mImageWidth,mImageHeight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Bitmap <span class="title">decodeSampledBitmapFromResource</span><span class="params">(Resources mResources, <span class="keyword">int</span> resId, <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">        BitmapFactory.decodeResource(mResources,resId,options);</span><br><span class="line">        options.inSampleSize = calculateInSampleSize(options,reqWidth,reqHeight);</span><br><span class="line">        <span class="keyword">if</span> (Utils.hasHoneycomb())&#123;</span><br><span class="line">            addInBitmapOptions(options);</span><br><span class="line">        &#125;</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BitmapFactory.decodeResource(mResources,resId,options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Bitmap <span class="title">decodeSampledBitmapFromFile</span><span class="params">(String fileName, <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">        BitmapFactory.decodeFile(fileName,options);</span><br><span class="line">        options.inSampleSize = calculateInSampleSize(options,reqWidth,reqHeight);</span><br><span class="line">        <span class="keyword">if</span> (Utils.hasHoneycomb())&#123;</span><br><span class="line">            addInBitmapOptions(options);</span><br><span class="line">        &#125;</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BitmapFactory.decodeFile(fileName, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeSampledBitmapFromDescriptor</span><span class="params">(FileDescriptor fileDescriptor, <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">        BitmapFactory.decodeFileDescriptor(fileDescriptor,<span class="keyword">null</span>, options);</span><br><span class="line">        options.inSampleSize = calculateInSampleSize(options,reqWidth,reqHeight);</span><br><span class="line">        <span class="keyword">if</span> (Utils.hasHoneycomb())&#123;</span><br><span class="line">            addInBitmapOptions(options);</span><br><span class="line">        &#125;</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>  BitmapFactory.decodeFileDescriptor(fileDescriptor, <span class="keyword">null</span>, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeSampledBitmapFromByteArray</span><span class="params">(<span class="keyword">byte</span>[] data,<span class="keyword">int</span> length,<span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">        BitmapFactory.decodeByteArray(data,<span class="number">0</span>,length,options);</span><br><span class="line">        options.inSampleSize = calculateInSampleSize(options,reqWidth,reqHeight);</span><br><span class="line">        <span class="keyword">if</span> (Utils.hasHoneycomb())&#123;</span><br><span class="line">            addInBitmapOptions(options);</span><br><span class="line">        &#125;</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>  BitmapFactory.decodeByteArray(data, <span class="number">0</span>, length, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeSampledBitmapFromStream</span><span class="params">(InputStream in, <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">        BitmapFactory.decodeStream(in,<span class="keyword">null</span>,options);</span><br><span class="line">        options.inSampleSize = calculateInSampleSize(options,reqWidth,reqHeight);</span><br><span class="line">        <span class="keyword">if</span> (Utils.hasHoneycomb())&#123;</span><br><span class="line">            addInBitmapOptions(options);</span><br><span class="line">        &#125;</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>   BitmapFactory.decodeStream(in, <span class="keyword">null</span>, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addInBitmapOptions</span><span class="params">(BitmapFactory.Options options)</span> </span>&#123;</span><br><span class="line">       options.inMutable = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculateInSampleSize</span><span class="params">(BitmapFactory.Options options, <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> outHeight = options.outHeight;</span><br><span class="line">        <span class="keyword">int</span> outWidth = options.outWidth;</span><br><span class="line">        String outMimeType = options.outMimeType;</span><br><span class="line">        Log.e(<span class="string">"Test"</span>, <span class="string">"outMimeType:"</span> + outMimeType + <span class="string">"  outWidth:"</span> + outWidth + <span class="string">"  outHeight:"</span> + outHeight);</span><br><span class="line">        <span class="keyword">int</span> inSampleSize = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (outHeight &gt; reqHeight || outWidth &gt; reqWidth) &#123;</span><br><span class="line">            <span class="keyword">int</span> halfHeight = outHeight / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">int</span> halfWidth = outWidth / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">while</span> ((halfHeight / inSampleSize) &gt; reqHeight &amp;&amp; (halfWidth / inSampleSize) &gt; reqWidth) &#123;</span><br><span class="line">                inSampleSize *= <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> totalPixels = outWidth * outHeight / inSampleSize;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> totalReqPixelsCap = reqWidth * reqHeight * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (totalPixels &gt; totalReqPixelsCap)&#123;</span><br><span class="line">                inSampleSize *= <span class="number">2</span>;</span><br><span class="line">                totalPixels /= <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inSampleSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Bitmap <span class="title">processBitmap</span><span class="params">(Object data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> processBitmap(Integer.parseInt(String.valueOf(data)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这部分代码是本篇开始讲解的部分。重新调整位图的大小，并提供了decode*的几个方法。<br>ImageFetcher的代码：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.net.ConnectivityManager;</span><br><span class="line"><span class="keyword">import</span> android.net.NetworkInfo;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="javadoc">/**</span><br><span class="line"> * Created by Administrator on 2015/6/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageFetcher</span> <span class="keyword">extends</span> <span class="title">ImageResizer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ImageFetcher</span><span class="params">(Context context, <span class="keyword">int</span> imageWidth, <span class="keyword">int</span> imageHeight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, imageWidth, imageHeight);</span><br><span class="line">        init(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ImageFetcher</span><span class="params">(Context context, <span class="keyword">int</span> imageSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, imageSize);</span><br><span class="line">        init(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        checkConnection(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkConnection</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        ConnectivityManager cm = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">        NetworkInfo networkInfo = cm.getActiveNetworkInfo();</span><br><span class="line">        <span class="keyword">if</span> (networkInfo == <span class="keyword">null</span> || !networkInfo.isConnectedOrConnecting()) &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">"无网络连接"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">            Log.e(<span class="string">"Test"</span>, <span class="string">"checkConnection---"</span> + <span class="string">"无网络连接"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Bitmap <span class="title">processBitmap</span><span class="params">(Object data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> processBitmap(String.valueOf(data));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Bitmap <span class="title">processBitmap</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">        InputStream is;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(data);</span><br><span class="line">            HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">            is = conn.getInputStream();</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = readStream(is);</span><br><span class="line">            <span class="keyword">if</span> (bytes != <span class="keyword">null</span>)&#123;</span><br><span class="line">                Bitmap bitmap = decodeSampledBitmapFromByteArray(bytes, bytes.length, mImageWidth, mImageHeight);</span><br><span class="line">                <span class="keyword">return</span> bitmap;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] readStream(InputStream inputStream) &#123;</span><br><span class="line">        ByteArrayOutputStream outputStrea = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> len;</span><br><span class="line">            <span class="keyword">while</span> ((len = inputStream.read(buff)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                outputStrea.write(buff, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> outputStrea.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>提供了网络加载的过程。<br>适配器：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"></span><br><span class="line"><span class="javadoc">/**</span><br><span class="line"> * Created by Administrator on 2015/6/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ImageFetcher mImageFetcher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> mImageSize = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageAdapter</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        mImageFetcher = <span class="keyword">new</span> ImageFetcher(context, mImageSize);</span><br><span class="line">        mImageFetcher.setmLoadingBitmap(R.mipmap.ic_launcher);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] URLS = &#123;</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383299_1976.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383291_6518.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383291_8239.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383290_9329.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383290_1042.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383275_3977.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383265_8550.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383264_3954.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383264_4787.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383264_8243.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383248_3693.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383243_5120.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383242_3127.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383242_9576.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383242_1721.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383219_5806.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383214_7794.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383213_4418.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383213_3557.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383210_8779.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383172_4577.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383166_3407.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383166_2224.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383166_7301.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383165_7197.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383150_8410.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383131_3736.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383130_5094.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383130_7393.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383129_8813.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383100_3554.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383093_7894.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383092_2432.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383092_3071.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383091_3119.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383059_6589.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383059_8814.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383059_2237.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383058_4330.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406383038_3602.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382942_3079.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382942_8125.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382942_4881.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382941_4559.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382941_3845.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382924_8955.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382923_2141.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382923_8437.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382922_6166.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382922_4843.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382905_5804.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382904_3362.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382904_2312.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382904_4960.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382900_2418.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382881_4490.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382881_5935.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382880_3865.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382880_4662.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382879_2553.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382862_5375.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382862_1748.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382861_7618.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382861_8606.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382861_8949.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382841_9821.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382840_6603.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382840_2405.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382840_6354.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382839_5779.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382810_7578.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382810_2436.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382809_3883.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382809_6269.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382808_4179.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382790_8326.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382789_7174.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382789_5170.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382789_4118.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382788_9532.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382767_3184.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382767_4772.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382766_4924.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382766_5762.jpg"</span>,</span><br><span class="line">            <span class="string">"http://img.my.csdn.net/uploads/201407/26/1406382765_7341.jpg"</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> URLS.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> URLS[position];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> URLS[position].hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        ViewHolder viewHolder;</span><br><span class="line">        <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            convertView = LayoutInflater.from(context).inflate(R.layout.item, <span class="keyword">null</span>);</span><br><span class="line">            viewHolder = <span class="keyword">new</span> ViewHolder();</span><br><span class="line">            viewHolder.imageView = (ImageView) convertView.findViewById(R.id.imageView);</span><br><span class="line">            convertView.setTag(viewHolder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            viewHolder = (ViewHolder) convertView.getTag();</span><br><span class="line">        &#125;</span><br><span class="line">        mImageFetcher.loadImage(URLS[position], viewHolder.imageView);</span><br><span class="line">        <span class="keyword">return</span> convertView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">        ImageView imageView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MainActivity:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.widget.ListView;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ListView listView = (ListView) findViewById(R.id.listView);</span><br><span class="line">        ImageAdapter adapter = <span class="keyword">new</span> ImageAdapter(<span class="keyword">this</span>);</span><br><span class="line">        listView.setAdapter(adapter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>两个辅助类:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.res.Resources;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.BitmapDrawable;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="javadoc">/**</span><br><span class="line"> * A BitmapDrawable that keeps track of whether it is being displayed or cached.</span><br><span class="line"> * when the drawable is no longer being displayed or cached,</span><br><span class="line"> * recycle() will be called on this drawable’s bitmap.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * Created by Administrator on 2015/6/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecyclingBitmapDrawable</span> <span class="keyword">extends</span> <span class="title">BitmapDrawable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCacheRefCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDisplayRefCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mHasBeenDisplayed;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RecyclingBitmapDrawable</span><span class="params">(Resources res, Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(res, bitmap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="javadoc">/**</span><br><span class="line">     * Notify the drawable that the displayed state has changed.Internally a</span><br><span class="line">     * count is kept so that the drawable knows when it is no longer being displayed.</span><br><span class="line">     *</span><br><span class="line">     *<span class="javadoctag"> @param</span> isDisplayed whether the drawable is being displayed or not</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsDisplayed</span><span class="params">(<span class="keyword">boolean</span> isDisplayed)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isDisplayed) &#123;</span><br><span class="line">                mDisplayRefCount++;</span><br><span class="line">                mHasBeenDisplayed = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mDisplayRefCount--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Check to see if recycle() can be called</span></span><br><span class="line">        checkState();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="javadoc">/**</span><br><span class="line">     * Notify the drawable that the cache state has changed.Internally a</span><br><span class="line">     * count is kept so that the drawable knows when it is no longer being cached.</span><br><span class="line">     *</span><br><span class="line">     *<span class="javadoctag"> @param</span> isCached whether the drawable is being cached or not</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsCached</span><span class="params">(<span class="keyword">boolean</span> isCached)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isCached) &#123;</span><br><span class="line">                mCacheRefCount++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mCacheRefCount--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Check to see if recycle() can be called</span></span><br><span class="line">        checkState();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">checkState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//If the drawable cache and display ref count = 0,and this drawable</span></span><br><span class="line">        <span class="comment">//has been displayed,then recycle.</span></span><br><span class="line">        <span class="keyword">if</span> (mCacheRefCount &lt;= <span class="number">0</span> &amp;&amp; mDisplayRefCount &lt;= <span class="number">0</span> &amp;&amp; mHasBeenDisplayed &amp;&amp; hasValidBitmap())&#123;</span><br><span class="line">            Log.e(<span class="string">"Test"</span>,<span class="string">"No longer being used or cached so recycling"</span>);</span><br><span class="line">            getBitmap().recycle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasValidBitmap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Bitmap bitmap = getBitmap();</span><br><span class="line">        <span class="keyword">return</span> bitmap != <span class="keyword">null</span> &amp;&amp; !bitmap.isRecycled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"></span><br><span class="line"><span class="javadoc">/**</span><br><span class="line"> * Created by Administrator on 2015/6/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Utils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasHoneycomb</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ok.本阶段告一段落，下面是缓存的部分。上面的两部分内容是所有开源图片加载库的基础，务必搞清楚。</p>
<h1 id="缓存位图">缓存位图</h1><p>加载单个的位图到用户的UI感觉很直接，但是在很多时候，例如ListView，GridView，ViewPager这样的控件，需要一次加载很多的图片，这样问题便复杂了很多。通常情况下比如ListView会复用它的子View，如果你不想保持长时间的引用(前面我们使用的是WeakReference)，GC会回收之前已经加载的位图。这看起来很好，但是如果你想保持流畅和快速滑动的UI，那么可能不想再去重新加载已经加载过但是被GC回收的位图。内存和硬盘缓存可以帮助我们快速加载位图。</p>
<h2 id="使用内存缓存">使用内存缓存</h2><p>内存缓存以占用应用内存为代价提供了快速访问内存的功能。<code>LruCache</code>(兼容包让低版本也可以使用)可以适合缓存位图的任务，它使用强引用的<code>LinkedHashMap</code>来保存最近的引用对象，在内存达到设计的大小之前将不经常使用的对象移除。<br>需要注意的是，在过去，一种流行的内存缓存实现是基于<code>SoftReference</code>和<code>WeakReference</code>,现在不再推荐这种方式。从Android 2.3(api 9)开始，GC对于收集soft/weak references更加具有侵入性，这让它们变得无效。此外，在Android3.0(api 11)之前，位图的备份数据存储在本地内存(native memory)中，它的释放是不可预测的，可能会造成应用超过内存的限制而崩溃。<br>为了选择合适的LruCache的大小，下面的因素需要考虑到：</p>
<ul>
<li>How memory intensive is the rest of your activity and/or application.(翻译过去太干硬，直接来原版)</li>
<li>一次性需要加载多少图片，下一步需要有多少才合适</li>
<li>屏幕的大小和密度</li>
<li>位图的配置和尺寸，每个要占据多大的内存</li>
<li>图片被访问有多频繁，如果有的需要更加频繁的被访问到，可以保持着这些位图一直在内存中或者是不同分组的位图分配多个LruCache对象</li>
<li>质量和数量之间的平衡，有时候存储大批数量的位图可能很用，可能在另外一个线程加载高质量的图片。<br>对于LruCache的大小，没有固定的大小或者公式，他取决于你的分析。下面是一个例子。<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.BitmapDrawable;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.util.LruCache;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="javadoc">/**</span><br><span class="line"> * Created by Administrator on 2015/6/4.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageCache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LruCache&lt;String, BitmapDrawable&gt; mMemoryCache;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> maxMemory = (<span class="keyword">int</span>) (Runtime.getRuntime().maxMemory() / <span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> cacheSize = maxMemory / <span class="number">8</span>;</span><br><span class="line">        mMemoryCache = <span class="keyword">new</span> LruCache&lt;String, BitmapDrawable&gt;(cacheSize) &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">sizeOf</span><span class="params">(String key, BitmapDrawable value)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> value.getBitmap().getByteCount() / <span class="number">1024</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBitmapToMemoryCache</span><span class="params">(String key, BitmapDrawable value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getBitmapFromMemCache(key) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mMemoryCache.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BitmapDrawable <span class="title">getBitmapFromMemCache</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BitmapDrawable memValue = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mMemoryCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">            memValue = mMemoryCache.get(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.e(<span class="string">"Test"</span>, <span class="string">"getBitmapFromMemCache----"</span> + <span class="string">"命中"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> memValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在上面的代码中，应用程序的八分之一被分配给缓存。在normal/hdpi的设备中，这大概是4MB(32/8)。在一个800<em>480分辨率的设备上，一个GridView在全屏下的图片大概占了1.5MB(800</em>480*4).所以大概可以缓存2.5页。<br>当加载位图到ImageView上的时候，LruCache会先被检查，如果entry存在，那么会用作更新ImageView，否则在后台线程去处理这个。<br>更改上面ImageWorker的代码：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadImage</span><span class="params">(Object data, ImageView imageView)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> String imageKey = String.valueOf(data);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      BitmapDrawable value = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (mImageCache != <span class="keyword">null</span>)&#123;</span><br><span class="line">          value = mImageCache.getBitmapFromMemCache(String.valueOf(data));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">          imageView.setImageDrawable(value);</span><br><span class="line">      &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span><span class="params">(cancelPotentialWork(data, imageView)</span>) </span>&#123;</span><br><span class="line">          BitmapWorkerTask task = <span class="keyword">new</span> BitmapWorkerTask(data, imageView);</span><br><span class="line">          AsyncDrawable asyncDrawable = <span class="keyword">new</span> AsyncDrawable(mResources, mLoadingBitmap, task);</span><br><span class="line">          imageView.setImageDrawable(asyncDrawable);</span><br><span class="line"></span><br><span class="line">          task.execute();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>BitmapWorkerTask</code>也需要更新，将entries添加到内存缓存中。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> BitmapDrawable <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">           Log.d(<span class="string">"Test"</span>, <span class="string">"doInBackground----starting work"</span>);</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">final</span> String dataString = String.valueOf(mData);</span><br><span class="line">           </span><br><span class="line">           Bitmap bitmap = <span class="keyword">null</span>;</span><br><span class="line">           BitmapDrawable drawable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (bitmap == <span class="keyword">null</span> &amp;&amp; !isCancelled() &amp;&amp; getAttachedImageView() != <span class="keyword">null</span>) &#123;</span><br><span class="line">               bitmap = processBitmap(mData);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (Utils.hasHoneycomb()) &#123;</span><br><span class="line">                   drawable = <span class="keyword">new</span> BitmapDrawable(mResources, bitmap);</span><br><span class="line">                   </span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   drawable = <span class="keyword">new</span> RecyclingBitmapDrawable(mResources, bitmap);</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">if</span> (mImageCache != <span class="keyword">null</span>)&#123;</span><br><span class="line">                   mImageCache.addBitmapToMemoryCache(dataString,drawable);</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">           &#125;</span><br><span class="line">           Log.d(<span class="string">"Test"</span>, <span class="string">"doInBackground----finish work"</span>);</span><br><span class="line">           <span class="keyword">return</span> drawable;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>运行的Log如下：<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">06-04 07:43:35.703    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:35.803    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:38.007    3866-3884/me.chenfuduo.displayingbitmaps E/Test﹕ outMimeType:image/jpeg  outWidth:240  outHeight:240</span><br><span class="line">06-04 07:43:38.823    3866-3884/me.chenfuduo.displayingbitmaps E/Test﹕ outMimeType:image/jpeg  outWidth:240  outHeight:240</span><br><span class="line">06-04 07:43:38.871    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:39.055    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:40.627    3866-3884/me.chenfuduo.displayingbitmaps E/Test﹕ outMimeType:image/jpeg  outWidth:240  outHeight:240</span><br><span class="line">06-04 07:43:40.723    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:40.803    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:40.919    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:41.203    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:41.755    3866-3884/me.chenfuduo.displayingbitmaps E/Test﹕ outMimeType:image/jpeg  outWidth:240  outHeight:240</span><br><span class="line">06-04 07:43:42.207    3866-3884/me.chenfuduo.displayingbitmaps E/Test﹕ outMimeType:image/jpeg  outWidth:240  outHeight:240</span><br><span class="line">06-04 07:43:42.271    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:42.403    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:42.523    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:42.755    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:42.987    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:43.671    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:43.755    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:43.903    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:44.139    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:44.295    3866-3884/me.chenfuduo.displayingbitmaps E/Test﹕ outMimeType:image/jpeg  outWidth:240  outHeight:240</span><br><span class="line">06-04 07:43:44.855    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:44.955    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:46.087    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:46.139    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:46.239    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:46.363    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:46.419    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:46.503    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:46.671    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br><span class="line">06-04 07:43:47.071    3866-3866/me.chenfuduo.displayingbitmaps E/Test﹕ getBitmapFromMemCache----命中</span><br></pre></td></tr></table></figure></p>
<h2 id="使用硬盘缓存">使用硬盘缓存</h2><p>内存缓存可以快速访问之前访问的位图，对于GridView这样带有大量数据集的控件，会很快的将内存缓存填充满。你的程序可能会被其他的任务打断，比如来电，然后后台任务可能会被杀死，这样内存缓存就销毁了。当用户再次进入的时候，应用还是得去再次加载。<br>硬盘缓存可以用来持久化处理位图，当内存缓存不可用时降低加载图片的时间。从硬盘加载图片的时间要慢于从内存中加载的时间，并且这个时间是不可预知的，所以需要放到后台的线程中。<br>需要注意的是：如果这些图片需要频繁的被访问到，最好使用ContentProvider。例如Gallery.下面的代码演示了硬盘缓存的做法。<br>DiskLruCache从源码中抽取出来的。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.BitmapDrawable;</span><br><span class="line"><span class="keyword">import</span> android.os.AsyncTask;</span><br><span class="line"><span class="keyword">import</span> android.os.Environment;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.util.LruCache;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="javadoc">/**</span><br><span class="line"> * Created by Administrator on 2015/6/4.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageCache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LruCache&lt;String, BitmapDrawable&gt; mMemoryCache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DiskLruCache mDiskLruCache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object mDiskCacheLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mDiskCacheStarting = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DISK_CACHE_SIZE = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DISK_CACHE_SUBDIR = <span class="string">"thumbnails"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DISK_CACHE_INDEX = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageCache</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> maxMemory = (<span class="keyword">int</span>) (Runtime.getRuntime().maxMemory() / <span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> cacheSize = maxMemory / <span class="number">8</span>;</span><br><span class="line">        mMemoryCache = <span class="keyword">new</span> LruCache&lt;String, BitmapDrawable&gt;(cacheSize) &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">sizeOf</span><span class="params">(String key, BitmapDrawable value)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> value.getBitmap().getByteCount() / <span class="number">1024</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        File cacheDir = getDiskCacheDir(context, DISK_CACHE_SUBDIR);</span><br><span class="line">        <span class="keyword">new</span> InitDiskCacheTask().execute(cacheDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">InitDiskCacheTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">File</span>, <span class="title">Void</span>, <span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Void <span class="title">doInBackground</span><span class="params">(File... params)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mDiskCacheLock) &#123;</span><br><span class="line">                File cacheDir = params[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mDiskLruCache = DiskLruCache.open(cacheDir, <span class="number">1</span>, <span class="number">1</span>, DISK_CACHE_SIZE);</span><br><span class="line">                    mDiskCacheStarting = <span class="keyword">false</span>;</span><br><span class="line">                    mDiskCacheLock.notifyAll();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">getDiskCacheDir</span><span class="params">(Context context, String uniqueName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String cachePath = Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState()) ||</span><br><span class="line">                !isExternalStorageRemovable() ? getExternalCacheDir(context).getPath() :</span><br><span class="line">                context.getCacheDir().getPath();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> File(cachePath + File.separator + uniqueName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isExternalStorageRemovable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Utils.hasGingerbread()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Environment.isExternalStorageRemovable();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">getExternalCacheDir</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Utils.hasFroyo()) &#123;</span><br><span class="line">            <span class="keyword">return</span> context.getExternalCacheDir();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String cacheDir = <span class="string">"/Android/data/"</span> + context.getPackageName() + <span class="string">"/cache/"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> File(Environment.getExternalStorageDirectory().getPath() + cacheDir);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBitmapToMemoryCache</span><span class="params">(String key, BitmapDrawable value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mDiskCacheLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mDiskLruCache != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                OutputStream out = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    DiskLruCache.Snapshot snapshot = mDiskLruCache.get(key);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (snapshot == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        DiskLruCache.Editor editor = mDiskLruCache.edit(key);</span><br><span class="line">                        <span class="keyword">if</span> (editor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            out = editor.newOutputStream(DISK_CACHE_INDEX);</span><br><span class="line">                            <span class="comment">// value.getBitmap().compress();TODO</span></span><br><span class="line">                            editor.commit();</span><br><span class="line">                            out.close();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        snapshot.getInputStream(DISK_CACHE_INDEX).close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            out.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getBitmapFromMemCache(key) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mMemoryCache.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BitmapDrawable <span class="title">getBitmapFromMemCache</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BitmapDrawable memValue = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mMemoryCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">            memValue = mMemoryCache.get(key);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (memValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.e(<span class="string">"Test"</span>, <span class="string">"getBitmapFromMemCache----"</span> + <span class="string">"命中"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> memValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Bitmap <span class="title">getBitmapFromDiskCache</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Bitmap bitmap = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mDiskCacheLock) &#123;</span><br><span class="line">            <span class="keyword">while</span> (mDiskCacheStarting) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mDiskCacheLock.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mDiskLruCache != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    DiskLruCache.Snapshot snapshot = mDiskLruCache.get(key);</span><br><span class="line">                    <span class="keyword">if</span> (snapshot != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Log.e(<span class="string">"Test"</span>, <span class="string">"硬盘缓存命中"</span>);</span><br><span class="line">                        inputStream = snapshot.getInputStream(DISK_CACHE_INDEX);</span><br><span class="line">                        <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            FileDescriptor fd = ((FileInputStream) inputStream).getFD();</span><br><span class="line">                            bitmap = ImageResizer.decodeSampledBitmapFromDescriptor(fd, Integer.MAX_VALUE, Integer.MAX_VALUE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            inputStream.close();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> bitmap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意的是初始化硬盘缓存设计到硬盘操作，因此应该放到后台线程去操作，这意味着硬盘缓存完成之前，硬盘缓存是可以被访问到的。我们需要阻止这样的操作，因此上面的代码我们加了一个锁对象，保证硬盘缓存初始化完成之后才可以被访问。<br>内存缓存是在UI线程做检查的，而硬盘缓存需要在后台线程完成，硬盘缓存永远不应该放在主线程中去完成。当图片加载完成后，最终的位图被加到内存缓存和硬盘缓存中。</p>
<h2 id="处理配置的改变">处理配置的改变</h2><p>运行时的改变，例如屏幕的旋转，会销毁和重建<code>running activity</code>的配置。我们不想因为运行时配置的改变而去重新加载图片，所以下面处理这部分。幸运的是，在上面的部分中，我们构建了很好的位图内存缓存，通过调用<code>setRetainInstance(true)</code>保存的Fragment可以将缓存传给新的Activity实例。当Activity重建后，保留的Fragment重新连接上，我们就可以访问已存在的缓存对象，这样就可以将其填充到ImageView上，下面是简单的代码演示：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> LruCache&lt;String, Bitmap&gt; mMemoryCache;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    RetainFragment retainFragment =</span><br><span class="line">            RetainFragment.findOrCreateRetainFragment(getFragmentManager());</span><br><span class="line">    mMemoryCache = retainFragment.mRetainedCache;</span><br><span class="line">    <span class="keyword">if</span> (mMemoryCache == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mMemoryCache = <span class="keyword">new</span> LruCache&lt;String, Bitmap&gt;(cacheSize) &#123;</span><br><span class="line">            ... <span class="comment">// Initialize cache here as usual</span></span><br><span class="line">        &#125;</span><br><span class="line">        retainFragment.mRetainedCache = mMemoryCache;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetainFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"RetainFragment"</span>;</span><br><span class="line">    <span class="keyword">public</span> LruCache&lt;String, Bitmap&gt; mRetainedCache;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RetainFragment</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RetainFragment <span class="title">findOrCreateRetainFragment</span><span class="params">(FragmentManager fm)</span> </span>&#123;</span><br><span class="line">        RetainFragment fragment = (RetainFragment) fm.findFragmentByTag(TAG);</span><br><span class="line">        <span class="keyword">if</span> (fragment == <span class="keyword">null</span>) &#123;</span><br><span class="line">            fragment = <span class="keyword">new</span> RetainFragment();</span><br><span class="line">            fm.beginTransaction().add(fragment, TAG).commit();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fragment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setRetainInstance(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ok,到这里，缓存部分处理完毕，包括内存缓存和硬盘缓存还有运行时数据的变化。下面会介绍管理位图的内存。</p>
<h1 id="管理位图的内存">管理位图的内存</h1><p>本部分介绍根据Android的版本不同，介绍几种利于GC和位图复用的技巧。Android关于位图内存管理上有下面的版本的不同：</p>
<ul>
<li>在Android2.2或者之前，当GC发生的时候，程序的线程停止，这会造成停滞影响性能，Android2.3添加并发GC，这意味着位图不被引用的时候会很快被回收。(Android 2.3 adds concurrent garbage collection, which means that the memory is reclaimed soon after a bitmap is no longer referenced.)</li>
<li>在Android2.3.3或者之前，位图的备份像素存储在本地内存中，和位图本身是分开的，位图是存储在Dalvik堆中的，本地内存中的像素数据的释放是不可预测的，这可能会造成应用超出内存而崩溃。从Android3.0开始后，像素数据就和位图存储在一起了，都在Dalvik堆中。<h2 id="管理Android2-3-3或者更低的版本">管理Android2.3.3或者更低的版本</h2>在Andorid2.3.3或者更低的版本，使用<code>recycle()</code>方法是推荐的，如果你的应用中展示大量的位图数据，你可能会遇到OOM的错误，使用<code>recycle()</code>方法可以让应用尽快的回收内存。<br>注意的是：<br>当时用<code>recycle()</code>方法的时候，你一定要保证当前的位图不再被使用。如果已经调用了<code>recycle()</code>方法，接着又试图去画这个位图，那么会得到这样的错误:<code>Canvas:trying to use a recycled bitmap</code><br>下面的代码使用引用计数(<code>mDisplayRefCount and mCacheRefCount</code>)的方式去追踪位图当前是否正在被展示或者位于缓存中。<br>下面的代码碰到下面的情况会回收位图：</li>
<li>两个引用计数的值都为0;</li>
<li>位图不为null,并且当前没有被回收。<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.displayingbitmaps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.res.Resources;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.BitmapDrawable;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="javadoc">/**</span><br><span class="line"> * A BitmapDrawable that keeps track of whether it is being displayed or cached.</span><br><span class="line"> * when the drawable is no longer being displayed or cached,</span><br><span class="line"> * recycle() will be called on this drawable’s bitmap.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * Created by Administrator on 2015/6/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecyclingBitmapDrawable</span> <span class="keyword">extends</span> <span class="title">BitmapDrawable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCacheRefCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDisplayRefCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mHasBeenDisplayed;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RecyclingBitmapDrawable</span><span class="params">(Resources res, Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(res, bitmap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="javadoc">/**</span><br><span class="line">     * Notify the drawable that the displayed state has changed.Internally a</span><br><span class="line">     * count is kept so that the drawable knows when it is no longer being displayed.</span><br><span class="line">     *</span><br><span class="line">     *<span class="javadoctag"> @param</span> isDisplayed whether the drawable is being displayed or not</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsDisplayed</span><span class="params">(<span class="keyword">boolean</span> isDisplayed)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isDisplayed) &#123;</span><br><span class="line">                mDisplayRefCount++;</span><br><span class="line">                mHasBeenDisplayed = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mDisplayRefCount--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Check to see if recycle() can be called</span></span><br><span class="line">        checkState();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="javadoc">/**</span><br><span class="line">     * Notify the drawable that the cache state has changed.Internally a</span><br><span class="line">     * count is kept so that the drawable knows when it is no longer being cached.</span><br><span class="line">     *</span><br><span class="line">     *<span class="javadoctag"> @param</span> isCached whether the drawable is being cached or not</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsCached</span><span class="params">(<span class="keyword">boolean</span> isCached)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isCached) &#123;</span><br><span class="line">                mCacheRefCount++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mCacheRefCount--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Check to see if recycle() can be called</span></span><br><span class="line">        checkState();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">checkState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//If the drawable cache and display ref count = 0,and this drawable</span></span><br><span class="line">        <span class="comment">//has been displayed,then recycle.</span></span><br><span class="line">        <span class="keyword">if</span> (mCacheRefCount &lt;= <span class="number">0</span> &amp;&amp; mDisplayRefCount &lt;= <span class="number">0</span> &amp;&amp; mHasBeenDisplayed &amp;&amp; hasValidBitmap())&#123;</span><br><span class="line">            Log.e(<span class="string">"Test"</span>,<span class="string">"No longer being used or cached so recycling"</span>);</span><br><span class="line">            getBitmap().recycle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasValidBitmap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Bitmap bitmap = getBitmap();</span><br><span class="line">        <span class="keyword">return</span> bitmap != <span class="keyword">null</span> &amp;&amp; !bitmap.isRecycled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="管理Android3-0或者更高的版本">管理Android3.0或者更高的版本</h2><p>Android3.0引入了<code>BitmapFactory.Options.inBitmap</code>属性，如果这个option被设置，当加载内容的时候，解析方法携带<code>Options</code>对象将会试图使用已经存在的位图对象。这意味着位图的内存被重新使用，让性能得到提升，去除了内存的分配和解除分配(memory allocation and de-allocation)。然后，使用<code>inBitmap</code>也有一定的局限性。在Andorid4.4之前，只有相同大小的位图支持。</p>
<ul>
<li><p>Save a bitmap for later use<br>下面的代码演示了已经存在的位图被保存以后可能会用到。当程序运行在Android3.0或者更高的版本，当Bitmap从LruCache被剔除的时候，位图的软引用会被放置到<code>HashSet</code>中，为了以后可能使用<code>inBitmap</code>来复用(When an app is running on Android 3.0 or higher and a bitmap is evicted from the LruCache, a soft reference to the bitmap is placed in a HashSet, for possible reuse later with inBitmap: )</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Set&lt;SoftReference&lt;Bitmap&gt;&gt; mReusableBitmaps;</span><br><span class="line"><span class="keyword">private</span> LruCache&lt;String, BitmapDrawable&gt; mMemoryCache;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If you're running on Honeycomb or newer, create a</span></span><br><span class="line"><span class="comment">// synchronized HashSet of references to reusable bitmaps.</span></span><br><span class="line"><span class="keyword">if</span> (Utils.hasHoneycomb()) &#123;</span><br><span class="line">    mReusableBitmaps =</span><br><span class="line">            Collections.synchronizedSet(<span class="keyword">new</span> HashSet&lt;SoftReference&lt;Bitmap&gt;&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mMemoryCache = <span class="keyword">new</span> LruCache&lt;String, BitmapDrawable&gt;(mCacheParams.memCacheSize) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notify the removed entry that is no longer being cached.</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">entryRemoved</span><span class="params">(<span class="keyword">boolean</span> evicted, String key,</span><br><span class="line">            BitmapDrawable oldValue, BitmapDrawable newValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (RecyclingBitmapDrawable.class.isInstance(oldValue)) &#123;</span><br><span class="line">            <span class="comment">// The removed entry is a recycling drawable, so notify it</span></span><br><span class="line">            <span class="comment">// that it has been removed from the memory cache.</span></span><br><span class="line">            ((RecyclingBitmapDrawable) oldValue).setIsCached(<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// The removed entry is a standard BitmapDrawable.</span></span><br><span class="line">            <span class="keyword">if</span> (Utils.hasHoneycomb()) &#123;</span><br><span class="line">                <span class="comment">// We're running on Honeycomb or later, so add the bitmap</span></span><br><span class="line">                <span class="comment">// to a SoftReference set for possible use with inBitmap later.</span></span><br><span class="line">                mReusableBitmaps.add</span><br><span class="line">                        (<span class="keyword">new</span> SoftReference&lt;Bitmap&gt;(oldValue.getBitmap()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Use an existing bitmap</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeSampledBitmapFromFile</span><span class="params">(String filename,</span><br><span class="line">        <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight, ImageCache cache)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">    ...</span><br><span class="line">    BitmapFactory.decodeFile(filename, options);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we're running on Honeycomb or newer, try to use inBitmap.</span></span><br><span class="line">    <span class="keyword">if</span> (Utils.hasHoneycomb()) &#123;</span><br><span class="line">        addInBitmapOptions(options, cache);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> BitmapFactory.decodeFile(filename, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>下面的代码是<code>addInBitmapOptions()</code>，它寻找已经存在的位图并将其设置为<code>inBitmap</code>的值。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addInBitmapOptions</span><span class="params">(BitmapFactory.Options options,</span><br><span class="line">        ImageCache cache)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// inBitmap only works with mutable bitmaps, so force the decoder to</span></span><br><span class="line">    <span class="comment">// return mutable bitmaps.</span></span><br><span class="line">    options.inMutable = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Try to find a bitmap to use for inBitmap.</span></span><br><span class="line">        Bitmap inBitmap = cache.getBitmapFromReusableSet(options);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (inBitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If a suitable bitmap has been found, set it as the value of</span></span><br><span class="line">            <span class="comment">// inBitmap.</span></span><br><span class="line">            options.inBitmap = inBitmap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This method iterates through the reusable bitmaps, looking for one </span></span><br><span class="line"><span class="comment">// to use for inBitmap:</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Bitmap <span class="title">getBitmapFromReusableSet</span><span class="params">(BitmapFactory.Options options)</span> </span>&#123;</span><br><span class="line">        Bitmap bitmap = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mReusableBitmaps != <span class="keyword">null</span> &amp;&amp; !mReusableBitmaps.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mReusableBitmaps) &#123;</span><br><span class="line">            <span class="keyword">final</span> Iterator&lt;SoftReference&lt;Bitmap&gt;&gt; iterator</span><br><span class="line">                    = mReusableBitmaps.iterator();</span><br><span class="line">            Bitmap item;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                item = iterator.next().get();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != item &amp;&amp; item.isMutable()) &#123;</span><br><span class="line">                    <span class="comment">// Check to see it the item can be used for inBitmap.</span></span><br><span class="line">                    <span class="keyword">if</span> (canUseForInBitmap(item, options)) &#123;</span><br><span class="line">                        bitmap = item;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Remove from reusable set so it can't be used again.</span></span><br><span class="line">                        iterator.remove();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Remove from the set if the reference has been cleared.</span></span><br><span class="line">                    iterator.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bitmap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后，this method determines whether a candidate bitmap satisfies the size criteria to be used for <code>inBitmap</code>:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">canUseForInBitmap</span><span class="params">(</span><br><span class="line">        Bitmap candidate, BitmapFactory.Options targetOptions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">        <span class="comment">// From Android 4.4 (KitKat) onward we can re-use if the byte size of</span></span><br><span class="line">        <span class="comment">// the new bitmap is smaller than the reusable bitmap candidate</span></span><br><span class="line">        <span class="comment">// allocation byte count.</span></span><br><span class="line">        <span class="keyword">int</span> width = targetOptions.outWidth / targetOptions.inSampleSize;</span><br><span class="line">        <span class="keyword">int</span> height = targetOptions.outHeight / targetOptions.inSampleSize;</span><br><span class="line">        <span class="keyword">int</span> byteCount = width * height * getBytesPerPixel(candidate.getConfig());</span><br><span class="line">        <span class="keyword">return</span> byteCount &lt;= candidate.getAllocationByteCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// On earlier versions, the dimensions must match exactly and the inSampleSize must be 1</span></span><br><span class="line">    <span class="keyword">return</span> candidate.getWidth() == targetOptions.outWidth</span><br><span class="line">            &amp;&amp; candidate.getHeight() == targetOptions.outHeight</span><br><span class="line">            &amp;&amp; targetOptions.inSampleSize == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="javadoc">/**</span><br><span class="line"> * A helper function to return the byte usage per pixel of a bitmap based on its configuration.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getBytesPerPixel</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (config == Config.ARGB_8888) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">    &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(config == Config.RGB_565)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(config == Config.ARGB_4444)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(config == Config.ALPHA_8)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ok,本部分到此结束，主要讲述不同版本对于内存的管理。</p>
<h1 id="Displaying_Bitmaps_in_Your_UI">Displaying Bitmaps in Your UI</h1><p>本部分包含两个内容，一个是将数据展示在ViewPager上，一个是将数据展示在GridView上，前面我们的例子已经演示了如何数据展示在ListView上。</p>
<h2 id="加载到ViewPager上">加载到ViewPager上</h2><p>这里唯一需要提到的是它说了这样的一句话：<br>FragmentStatePagerAdapter which automatically destroys and saves state of the Fragments in the ViewPager as they disappear off-screen, keeping memory usage down.<br>Note: If you have a smaller number of images and are confident they all fit within the application memory limit, then using a regular PagerAdapter or FragmentPagerAdapter might be more appropriate.<br>使用FragmentStatePagerAdapter会销毁掉不需要的Fragment。事务提交后，可将Fragment从Activity的FragmentManager中彻底移除。FragmentStatePagerAdapter类名中的state表明：在销毁Fragment时，它会将其onSaveInstanceState(bundle)方法中的Bundle信息保存下来。用户切换回原来的页面后，保存的实例状态可用于恢复生成新的Fragmen。<br>相比之下FragmentPagerAdapter的做法大不相同，对于不再需要的Fragment，FragmentPagerAdapter则选择调用事务的detach(Fragment)方法，而非remove(Fragment)方法，来保留它。也就是说FragmentPagerAdapter只是销毁了Fragment的视图，但仍将Fragment实例保留在FragmentManager中。</p>
<h2 id="加载数据到GridView上">加载数据到GridView上</h2><p>所有的原理和前面的ListView一样，不再贴代码。<br>到这里，关于位图的处理告一段落。分别讲述了处理位图的尺寸，异步加载位图，缓存处理，内存管理，以及最后的数据展示，这些内容都是后面理解开源库比如UIL(Universal Image Loader)，Glide等等的基础。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/移动开发/">移动开发</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/移动开发/">移动开发</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://chenfuduo.me/2015/06/02/Displaying-Bitmaps-Efficiently/" data-title="Displaying Bitmaps Efficiently | louis.chen" data-tsina="2338582935" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/06/05/树的子结构/" title="树的子结构">
  <strong>上一篇：</strong><br/>
  <span>
  树的子结构</span>
</a>
</div>


<div class="next">
<a href="/2015/06/02/Binary-Tree-Upside-Down/"  title="Binary Tree Upside Down">
 <strong>下一篇：</strong><br/> 
 <span>Binary Tree Upside Down
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/06/02/Displaying-Bitmaps-Efficiently/" data-title="Displaying Bitmaps Efficiently" data-url="http://chenfuduo.me/2015/06/02/Displaying-Bitmaps-Efficiently/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#有效加载大位图"><span class="toc-number">1.</span> <span class="toc-text">有效加载大位图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#读取位图的尺寸和类型"><span class="toc-number">1.1.</span> <span class="toc-text">读取位图的尺寸和类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载缩小版本到内存"><span class="toc-number">1.2.</span> <span class="toc-text">加载缩小版本到内存</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#在UI线程之外处理位图"><span class="toc-number">2.</span> <span class="toc-text">在UI线程之外处理位图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用AsyncTask"><span class="toc-number">2.1.</span> <span class="toc-text">使用AsyncTask</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#处理并发"><span class="toc-number">2.2.</span> <span class="toc-text">处理并发</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#阶段案例总结"><span class="toc-number">3.</span> <span class="toc-text">阶段案例总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#总体分析"><span class="toc-number">3.1.</span> <span class="toc-text">总体分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#缓存位图"><span class="toc-number">4.</span> <span class="toc-text">缓存位图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用内存缓存"><span class="toc-number">4.1.</span> <span class="toc-text">使用内存缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用硬盘缓存"><span class="toc-number">4.2.</span> <span class="toc-text">使用硬盘缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#处理配置的改变"><span class="toc-number">4.3.</span> <span class="toc-text">处理配置的改变</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#管理位图的内存"><span class="toc-number">5.</span> <span class="toc-text">管理位图的内存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#管理Android2-3-3或者更低的版本"><span class="toc-number">5.1.</span> <span class="toc-text">管理Android2.3.3或者更低的版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#管理Android3-0或者更高的版本"><span class="toc-number">5.2.</span> <span class="toc-text">管理Android3.0或者更高的版本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Displaying_Bitmaps_in_Your_UI"><span class="toc-number">6.</span> <span class="toc-text">Displaying Bitmaps in Your UI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#加载到ViewPager上"><span class="toc-number">6.1.</span> <span class="toc-text">加载到ViewPager上</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载数据到GridView上"><span class="toc-number">6.2.</span> <span class="toc-text">加载数据到GridView上</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/MFC/" title="MFC">MFC<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/收藏/" title="收藏">收藏<sup>1</sup></a></li>
		  
		
		  
		
		  
			<li><a href="/categories/源码学习/" title="源码学习">源码学习<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活/" title="生活">生活<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/移动开发/" title="移动开发">移动开发<sup>51</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>43</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/移动开发/" title="移动开发">移动开发<sup>51</sup></a></li>
			
		
			
				<li><a href="/tags/算法/" title="算法">算法<sup>43</sup></a></li>
			
		
			
				<li><a href="/tags/自定义View/" title="自定义View">自定义View<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/源码学习/" title="源码学习">源码学习<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/UI-UE/" title="UI/UE">UI/UE<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/JVM/" title="JVM">JVM<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/生活/" title="生活">生活<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ViewDragHelper/" title="ViewDragHelper">ViewDragHelper<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/自定义控件/" title="自定义控件">自定义控件<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/HTTP通信/" title="HTTP通信">HTTP通信<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/收藏/" title="收藏">收藏<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/OAuth登陆/" title="OAuth登陆">OAuth登陆<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android动画/" title="Android动画">Android动画<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Socket通信/" title="Socket通信">Socket通信<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Volley/" title="Volley">Volley<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/异步任务处理/" title="异步任务处理">异步任务处理<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Design-Support-Library/" title="Design Support Library">Design Support Library<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/EventBus/" title="EventBus">EventBus<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/MFC/" title="MFC">MFC<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Bundle/" title="Bundle">Bundle<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://www.vogella.com/tutorials/android.html" target="_blank" title="Vogella">Vogella</a>
            
          </li>
        
    </ul>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=2338582935&verifier=59b78413&dpc=1"></iframe>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> louis.chen,student of USTC,Focus on mobile develop. <br/>
			It is my amibition to make beautiful apps.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2338582935" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/leerduo" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="/about" target="_blank" title="louis.chen">louis.chen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"chenlouis"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F63c029dba1e367df2c8ffa39a309056a' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
