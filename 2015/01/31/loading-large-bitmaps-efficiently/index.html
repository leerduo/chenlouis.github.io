
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Loading Large Bitmaps Efficiently | louis.chen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="louis.chen">
    
    <meta name="description" content="Images come in all shapes and sizes. In many cases they are larger than required for a typical application user interface (UI). For example, the syste">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="louis.chen" title="louis.chen"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="louis.chen">louis.chen</a></h1>
				<h2 class="blog-motto">Mobile developers,experience extreme product.</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">博客</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/01/31/loading-large-bitmaps-efficiently/" title="Loading Large Bitmaps Efficiently" itemprop="url">Loading Large Bitmaps Efficiently</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://yoursite.com" title="louis.chen">louis.chen</a>
    </p>
  <p class="article-time">
    <time datetime="2015-01-31T01:14:19.000Z" itemprop="datePublished">2015-01-31</time>
    更新日期:<time datetime="2015-04-20T07:21:35.635Z" itemprop="dateModified">2015-04-20</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Read_Bitmap_Dimensions_and_Type"><span class="toc-number">1.</span> <span class="toc-text">Read Bitmap Dimensions and Type</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Load_a_Scaled_Down_Version_into_Memory"><span class="toc-number">2.</span> <span class="toc-text">Load a Scaled Down Version into Memory</span></a></li></ol>
		</div>
		
		<p>Images come in all shapes and sizes. In many cases they are larger than required for a typical application user interface (UI). For example, the system Gallery application displays photos taken using your Android devices’s camera which are typically much higher resolution than the screen density of your device.</p>
<p>Given that you are working with limited memory, ideally you only want to load a lower resolution version in memory. The lower resolution version should match the size of the UI component that displays it. An image with a higher resolution does not provide any visible benefit, but still takes up precious memory and incurs additional performance overhead due to additional on the fly scaling.</p>
<p>This lesson walks you through decoding large bitmaps without exceeding the per application memory limit by loading a smaller subsampled version in memory.</p>
<p>译：</p>
<p>图片有不同的形状与大小。在大多数情况下它们的实际大小都比需要呈现出来的要大很多。例如，系统的Gallery程序会显示那些你使用设备camera拍摄的图片，但是那些图片的分辨率通常都比你的设备屏幕分辨率要高很多。</p>
<p>考虑到程序是在有限的内存下工作，理想情况是你只需要在内存中加载一个低分辨率的版本即可。这个低分辨率的版本应该是与你的UI大小所匹配的，这样才便于显示。一个高分辨率的图片不会提供任何可见的好处，却会占用宝贵的(precious)的内存资源，并且会在快速滑动图片时导致(incurs)附加的效率问题。</p>
<h2 id="Read_Bitmap_Dimensions_and_Type">Read Bitmap Dimensions and Type</h2><hr>
<p>The <code>[BitmapFactory](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.html)</code> class provides several decoding methods (<code>[decodeByteArray()](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.html#decodeByteArray(byte[], int, int, android.graphics.BitmapFactory.Options))</code>, <code>[decodeFile()](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.html#decodeFile(java.lang.String, android.graphics.BitmapFactory.Options))</code>,<code>[decodeResource()](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.html#decodeResource(android.content.res.Resources, int, android.graphics.BitmapFactory.Options))</code>, etc.) for creating a <code>[Bitmap](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/Bitmap.html)</code> from various sources. Choose the most appropriate decode method based on your image data source. These methods attempt to allocate memory for the constructed bitmap and therefore can easily result in an <code>OutOfMemory</code> exception. Each type of decode method has additional signatures that let you specify decoding options via the <code>[BitmapFactory.Options](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html)</code>class. Setting the <code>[inJustDecodeBounds](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html#inJustDecodeBounds)</code> property to <code>true</code> while decoding avoids memory allocation, returning <code>null</code> for the bitmap object but setting <code>[outWidth](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html#outWidth)</code>, <code>[outHeight](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html#outHeight)</code> and <code>[outMimeType](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html#outMimeType)</code>. This technique allows you to read the dimensions and type of the image data prior to construction (and memory allocation) of the bitmap.</p>
<p>[java]<br>BitmapFactory.Options options = new BitmapFactory.Options();<br>options.inJustDecodeBounds = true;<br>BitmapFactory.decodeResource(getResources(), R.id.myimage, options);<br>int imageHeight = options.outHeight;<br>int imageWidth = options.outWidth;<br>String imageType = options.outMimeType;<br>[/java]</p>
<p>To avoid <code>java.lang.OutOfMemory</code> exceptions, check the dimensions of a bitmap before decoding it, unless you absolutely trust the source to provide you with predictably sized image data that comfortably fits within the available memory.</p>
<p>译：</p>
<p>BitmapFactory 类提供了一些decode的方法 (<a href="http://developer.android.com/reference/android/graphics/BitmapFactory.html#decodeByteArray(byte[], int, int, android.graphics.BitmapFactory.Options" target="_blank" rel="external">decodeByteArray()</a>), <a href="http://developer.android.com/reference/android/graphics/BitmapFactory.html#decodeFile(java.lang.String, android.graphics.BitmapFactory.Options" target="_blank" rel="external">decodeFile()</a>), <a href="http://developer.android.com/reference/android/graphics/BitmapFactory.html#decodeResource(android.content.res.Resources, int, android.graphics.BitmapFactory.Options" target="_blank" rel="external">decodeResource()</a>), etc.) 用来从不同的资源中创建一个Bitmap. 根据你的图片数据源来选择合适的decode方法. 那些方法<span style="color: #000080;"><strong>在构造位图的时候会尝试分配内存</strong></span>，因此会容易导致<code>OutOfMemory</code>的异常。每一种decode方法都提供了通过<a href="http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html" target="_blank" rel="external">BitmapFactory.Options</a> 来设置一些附加的标记来指定decode的选项。设置 <a href="http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#inJustDecodeBounds" target="_blank" rel="external">inJustDecodeBounds</a> 属性<span style="color: #000080;"><strong>为<code>true</code>可以在decoding的时候避免内存的分配</strong></span>，它会返回一个<code>null</code>的bitmap，<strong><span style="color: #000080;">但是 outWidth, outHeight 与 outMimeType 还是可以获取</span></strong>。这个技术可以允许你在构造bitmap之前优先读图片的尺寸与类型。</p>
<h2 id="Load_a_Scaled_Down_Version_into_Memory">Load a Scaled Down Version into Memory</h2><hr>
<p>Now that the image dimensions are known, they can be used to decide if the full image should be loaded into memory or if a subsampled version should be loaded instead. Here are some factors to consider:</p>
<ul>
<li>Estimated memory usage of loading the full image in memory.</li>
<li>Amount of memory you are willing to commit to loading this image given any other memory requirements of your application.</li>
<li>Dimensions of the target <code>[ImageView](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/widget/ImageView.html)</code> or UI component that the image is to be loaded into.</li>
<li>Screen size and density of the current device.<br>For example, it’s not worth loading a 1024x768 pixel image into memory if it will eventually be displayed in a 128x96 pixel thumbnail in an <code>[ImageView](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/widget/ImageView.html)</code>.</li>
</ul>
<p>To tell the decoder to subsample the image, loading a smaller version into memory, set <code>[inSampleSize](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html#inSampleSize)</code>to <code>true</code> in your <code>[BitmapFactory.Options](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html)</code> object. For example, an image with resolution 2048x1536 that is decoded with an <code>[inSampleSize](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html#inSampleSize)</code> of 4 produces a bitmap of approximately 512x384. Loading this into memory uses 0.75MB rather than 12MB for the full image (assuming a bitmap configuration of<code>[ARGB_8888](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/Bitmap.Config.html)</code>). Here’s a method to calculate a sample size value that is a power of two based on a target width and height:</p>
<p>译：</p>
<p>通过上面的步骤我们已经知道了图片的尺寸，那些数据可以用来决定是应该加载整个图片到内存中还是加载一个缩小的版本。有下面一些因素需要考虑：</p>
<ul>
<li><span style="color: #000080;">评估加载完整图片所需要耗费的内存。</span></li>
<li><span style="color: #000080;">程序在加载这张图片时会涉及到其他内存需求。</span></li>
<li><span style="color: #000080;">呈现这张图片的组件的尺寸大小。</span></li>
<li><span style="color: #000080;">屏幕大小与当前设备的屏幕密度。</span><br>例如，如果把一个原图是<code>1024*768</code> pixel的图片显示到ImageView为<code>128*96</code> pixel的缩略图就没有必要把整张图片都加载到内存中。</li>
</ul>
<p>为了告诉decoder去加载一个低版本的图片到内存，<span style="color: #000080;">需要在你的<a href="http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html" target="_blank" rel="external"><span style="color: #000080;">BitmapFactory.Options</span></a> 中设置 inSampleSize 为 <code>true</code></span> 。For example, 一个分辨率为2048x1536 的图片，如果设置 inSampleSize 为4，那么会产出一个大概为512x384的bitmap。加载这张小的图片仅仅使用大概<span style="color: #000080;">0.75MB</span>，如果是加载全图那么大概要花费<span style="color: #000080;">12MB</span>(前提都是bitmap的配置是 ARGB_8888). 下面有一段根据目标图片大小来计算Sample图片大小的Sample Code:</p>
<p>[java]<br>&lt;pre&gt;public static int calculateInSampleSize(<br>            BitmapFactory.Options options, int reqWidth, int reqHeight) {<br>    // Raw height and width of image<br>    final int height = options.outHeight;<br>    final int width = options.outWidth;<br>    int inSampleSize = 1;</p>
<pre><code><span class="keyword">if</span> (<span class="variable">height</span> &amp;gt; reqHeight || <span class="variable">width</span> &amp;gt; reqWidth) {

    <span class="keyword">final</span> <span class="built_in">int</span> halfHeight = <span class="variable">height</span> / <span class="number">2</span>;
    <span class="keyword">final</span> <span class="built_in">int</span> halfWidth = <span class="variable">width</span> / <span class="number">2</span>;

    <span class="comment">// Calculate the largest inSampleSize value that is a power of 2 and keeps both</span>
    <span class="comment">// height and width larger than the requested height and width.</span>
    <span class="keyword">while</span> ((halfHeight / inSampleSize) &amp;gt; reqHeight
            &amp;amp;&amp;amp; (halfWidth / inSampleSize) &amp;gt; reqWidth) {
        inSampleSize *= <span class="number">2</span>;
    }
}

<span class="keyword">return</span> inSampleSize;
</code></pre><p>}&lt;/pre&gt;<br>[/java]</p>
<p><strong>Note:</strong> A power of two value is calculated because the decoder uses a final value by rounding down to the nearest power of two, as per the <code>[inSampleSize](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html#inSampleSize)</code> documentation.(文档是这样说的：If set to a value &gt; 1, requests the decoder to subsample the original image, returning a smaller image to save memory. The sample size is the number of pixels in either dimension that correspond to a single pixel in the decoded bitmap. For example, inSampleSize == 4 returns an image that is 1/4 the width/height of the original, and 1/16 the number of pixels. Any value &lt;= 1 is treated the same as 1. Note: the decoder uses a final value based on powers of 2, any other value will be rounded down to the nearest power of 2.)假如inSampleSize为4，宽高尺寸会缩小到原来的四分之一，分辨率会缩小到原来的十六分之一。如果inSampleSize小于等于1，则其为1.</p>
<p>To use this method, first decode with <code>[inJustDecodeBounds](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html#inJustDecodeBounds)</code> set to <code>true</code>, pass the options through and then decode again using the new <code>[inSampleSize](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html#inSampleSize)</code> value and <code>[inJustDecodeBounds](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/graphics/BitmapFactory.Options.html#inJustDecodeBounds)</code> set to <code>false</code>:</p>
<p>译：</p>
<p>为了使用这个方法，首先需要设置 <a href="http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#inJustDecodeBounds" target="_blank" rel="external">inJustDecodeBounds</a> 为 <code>true</code>, 把options的值传递过来，然后使用<a href="http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#inSampleSize" target="_blank" rel="external">inSampleSize</a> 的值并设置 inJustDecodeBounds 为 <code>false</code> 来重新Decode一遍。</p>
<p>[java]<br>&lt;pre&gt;public static Bitmap decodeSampledBitmapFromResource(Resources res, int resId,<br>        int reqWidth, int reqHeight) {</p>
<pre><code><span class="comment">// First decode with inJustDecodeBounds=true to check dimensions</span>
<span class="keyword">final</span> BitmapFactory.<span class="keyword">Options</span> <span class="keyword">options</span> = <span class="keyword">new</span> BitmapFactory.<span class="keyword">Options</span>();
<span class="keyword">options</span>.inJustDecodeBounds = <span class="keyword">true</span>;
BitmapFactory.decodeResource(res, resId, <span class="keyword">options</span>);

<span class="comment">// Calculate inSampleSize</span>
<span class="keyword">options</span>.inSampleSize = calculateInSampleSize(<span class="keyword">options</span>, reqWidth, reqHeight);

<span class="comment">// Decode bitmap with inSampleSize set</span>
<span class="keyword">options</span>.inJustDecodeBounds = <span class="keyword">false</span>;
<span class="keyword">return</span> BitmapFactory.decodeResource(res, resId, <span class="keyword">options</span>);
</code></pre><p>}&lt;/pre&gt;<br>[/java]</p>
<p>This method makes it easy to load a bitmap of arbitrarily large size into an <code>[ImageView](file:///D:/Users/Administrator/AppData/Local/Android/sdk/docs/reference/android/widget/ImageView.html)</code> that displays a 100x100 pixel thumbnail, as shown in the following example code:</p>
<p>译：使用上面这个方法可以简单的加载一个任意大小的图片并显示为100*100 pixel的缩略图形式。像下面演示的一样:</p>
<p>[java]<br>&lt;pre&gt;mImageView.setImageBitmap(<br>    decodeSampledBitmapFromResource(getResources(), R.id.myimage, 100, 100));&lt;/pre&gt;<br>[/java]</p>
<p>&nbsp;</p>
  
	</div>
		<footer class="article-footer clearfix">


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android开发/">Android开发</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://yoursite.com/2015/01/31/loading-large-bitmaps-efficiently/" data-title="Loading Large Bitmaps Efficiently | louis.chen" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/01/31/processing-bitmaps-off-the-ui-thread/" title="Processing Bitmaps Off the UI Thread">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Processing Bitmaps Off the UI Thread</span>
</a>
</div>


<div class="next">
<a href="/2015/01/31/displaying-bitmaps-efficiently/"  title="Displaying Bitmaps Efficiently">
 <strong>NEXT:</strong><br/> 
 <span>Displaying Bitmaps Efficiently
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Read_Bitmap_Dimensions_and_Type"><span class="toc-number">1.</span> <span class="toc-text">Read Bitmap Dimensions and Type</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Load_a_Scaled_Down_Version_into_Memory"><span class="toc-number">2.</span> <span class="toc-text">Load a Scaled Down Version into Memory</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android开发/" title="Android开发">Android开发<sup>21</sup></a></li>
		
			<li><a href="/categories/Android开源框架/" title="Android开源框架">Android开源框架<sup>4</sup></a></li>
		
			<li><a href="/categories/Android开发/Dandelion/" title="Dandelion">Dandelion<sup>1</sup></a></li>
		
			<li><a href="/categories/Java/" title="Java">Java<sup>1</sup></a></li>
		
			<li><a href="/categories/Android开发/Training文档/" title="Training文档">Training文档<sup>9</sup></a></li>
		
			<li><a href="/categories/Training文档/" title="Training文档">Training文档<sup>9</sup></a></li>
		
			<li><a href="/categories/blog/" title="blog">blog<sup>1</sup></a></li>
		
			<li><a href="/categories/未分类/" title="未分类">未分类<sup>0</sup></a></li>
		
			<li><a href="/categories/自定义控件/" title="自定义控件">自定义控件<sup>4</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/博客/" title="博客">博客<sup>1</sup></a></li>
		
			<li><a href="/tags/文章/" title="文章">文章<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> louis.chen,student of USTC,Focus on mobile develop. <br/>
			It is my amibition to develop beautiful app.</p>
	</section>
	 
	<div class="social-font clearfix">
		
		<a href="http://weibo.com/2338582935" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/leerduo" target="_blank" title="github"></a>
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://yoursite.com" target="_blank" title="louis.chen">louis.chen</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"null"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
