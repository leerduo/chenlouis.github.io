
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Java Formatters Best Practices | louis.chen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="louis.chen">
    
    <meta name="description" content="这篇文章来自：http://blog.vityuk.com/2011/03/java-formatters-best-practices.html
为什么有这篇文章？在BeautyProj这个项目的日志管理类，我需要java.text.DateFormat and java.text.NumberF">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="louis.chen" title="louis.chen"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="louis.chen">louis.chen</a></h1>
				<h2 class="blog-motto">Mobile developers,experience extreme product.</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">博客</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/04/java-formatters-best-practices/" title="Java Formatters Best Practices" itemprop="url">Java Formatters Best Practices</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://yoursite.com" title="louis.chen">louis.chen</a>
    </p>
  <p class="article-time">
    <time datetime="2015-02-04T05:52:41.000Z" itemprop="datePublished">2015-02-04</time>
    更新日期:<time datetime="2015-04-20T07:21:35.637Z" itemprop="dateModified">2015-04-20</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-_Local_format"><span class="toc-number">1.</span> <span class="toc-text">1. Local format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-_Shared_not_synchronized_format"><span class="toc-number">2.</span> <span class="toc-text">2. Shared not synchronized format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-_Shared_synchronized_format"><span class="toc-number">3.</span> <span class="toc-text">3. Shared synchronized format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-_Shared_thread_local_format"><span class="toc-number">4.</span> <span class="toc-text">4. Shared thread local format</span></a></li></ol>
		</div>
		
		<p>这篇文章来自：<a href="http://blog.vityuk.com/2011/03/java-formatters-best-practices.html" title="http://blog.vityuk.com/2011/03/java-formatters-best-practices.html" target="_blank" rel="external">http://blog.vityuk.com/2011/03/java-formatters-best-practices.html</a></p>
<p>为什么有这篇文章？在BeautyProj这个项目的日志管理类，我需要<code>java.text.DateFormat</code> and <code>java.text.NumberFormat去处理日期，考虑到线程安全的问题，我查下了资料（大百度没有找到，Google上找到的上面那个哥们的博客）</code></p>
<p>在这个哥们的博客当中，他提到了四种方案：看下：</p>
<p>Java API has set of classes for formatting and parsing dates and numbers. Mostly used are:<code>java.text.DateFormat</code> and <code>java.text.NumberFormat</code>. Often when interviewing candidates I ask them whether JDK date and number formatters are <span style="color: #0000ff;"><strong>thread-safe</strong></span>. Surprisingly most of them don’t know the right answer, hence I decided to describe common pitfalls with formatters usage.</p>
<p>As you can guess <strong><span style="color: #0000ff;">both <code>DateFormat</code> and <code>NumberFormat</code> are not thread-safe</span></strong>. This is old known Java API design mistake. Nowadays all agreed that they supposed to be immutable instead of mutable. There is awesome alternative for dates - <a href="http://joda-time.sourceforge.net/" target="_blank" rel="external">Joda Time</a>. （<a href="http://www.joda.org/joda-time/" title="http://www.joda.org/joda-time/" target="_blank" rel="external">http://www.joda.org/joda-time/</a>）Which is pretty mature and was taken as a base for <a href="http://java.net/projects/jsr-310/" target="_blank" rel="external">JSR-310</a>. I am personally recommend to stick with Joda Time if you can choose, because on our project we have great impression of using it. But if you have to deal with JDK date (and I don’t know good alternatives for numbers) you should be ready to use them correctly. Let’s go over formatting common patterns. In my examples I will use <code>SimpleDateFormatter</code> for formatting date. But all examples applicable for<code>NumberFormat</code> and for parsing strings.</p>
<h3 id="1-_Local_format">1. Local format</h3><div>

<p>[java]import java.text.SimpleDateFormat;<br>import java.util.Date;</p>
<p>public class FormatLocal {<br> public static void main(String[] args) {<br> format(new Date());<br> }</p>
<p>static String format(Date date) {<br> SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br> return format.format(date);<br> }<br>}[/java]</p>
<p></p></div><br>This is the most obvious and straightforward way of formatter usage. You just create local instance and use it right away. In most cases it’s sufficient and preferable way to use it. But a lot of people trying to optimize it and turn it into <a href="http://blog.vityuk.com/2011/03/java-formatters-best-practices.html#2" target="_blank" rel="external">2</a>.<p></p>
<h3 id="2-_Shared_not_synchronized_format">2. Shared not synchronized format</h3><div>

<p>[java]import java.text.SimpleDateFormat;<br>import java.util.Date;</p>
<p>public class FormatSharedBuggy {<br> public static void main(String[] args) {<br> format(new Date());<br> }</p>
<p>// DON’T DO IT!!! DateFormat is not thread-safe<br> private static final SimpleDateFormat FORMAT = new SimpleDateFormat(<br> &quot;yyyy-MM-dd HH:mm:ss&quot;);</p>
<p>static String format(Date date) {<br> return FORMAT.format(date);<br> }<br>}[/java]</p>
<p></p></div><br>This solution is a result of assumption (which looks logically) that <code>SimpleDateFormat</code> is thread-safe. But it’s not and this example is buggy. In multithread environment you’ll definitely get unpredictable results.<strong>DON’T DO IT!!!</strong><p></p>
<h3 id="3-_Shared_synchronized_format">3. Shared synchronized format</h3><div>

<p>[java]import java.text.SimpleDateFormat;<br>import java.util.Date;</p>
<p>public class FormatSharedSynchronized {<br> public static void main(String[] args) {<br> format(new Date());<br> }</p>
<p>// It’s safe to reuse it from synchronized method<br> private static final SimpleDateFormat FORMAT = new SimpleDateFormat(<br> &quot;yyyy-MM-dd HH:mm:ss&quot;);</p>
<p>synchronized static String format(Date date) {<br> return FORMAT.format(date);<br> }<br>}[/java]</p>
<p></p></div><br>This is quick obvious fix of previous approach. You just synchronize access to formatter. But this is not recommended way. This solution is not scalable by nature and suffer from thread contention. On multiprocessor systems it could become a bottleneck. And in this case even the <a href="http://blog.vityuk.com/2011/03/java-formatters-best-practices.html#1" target="_blank" rel="external">1</a> solution is a better way to go.<p></p>
<h3 id="4-_Shared_thread_local_format">4. Shared thread local format</h3><div>

<p>[java]import java.text.SimpleDateFormat;<br>import java.util.Date;</p>
<p>public class FormatThreadLocal {<br> public static void main(String[] args) {<br> format(new Date());<br> }</p>
<p>private static final ThreadLocal&lt;SimpleDateFormat&gt; FORMAT = new ThreadLocal&lt;SimpleDateFormat&gt;() {<br> @Override<br> protected SimpleDateFormat initialValue() {<br> return new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br> }<br> };</p>
<p>static String format(Date date) {<br> return FORMAT.get().format(date);<br> }<br>}[/java]</p>
<p></p></div><br>But if you really think (at this place you should measure real performance benefit) you will gain from formatter reuse, you should consider to use <a href="http://download.oracle.com/javase/6/docs/api/java/lang/ThreadLocal.html" target="_blank" rel="external">TreadLocal</a>. In this example formatter will be shared only within thread.<p></p>
<p>We reviewed all cases and I would really recommend to keep away from <a href="http://blog.vityuk.com/2011/03/java-formatters-best-practices.html#2" target="_blank" rel="external">2</a> and <a href="http://blog.vityuk.com/2011/03/java-formatters-best-practices.html#3" target="_blank" rel="external">3</a> solutions. <a href="http://blog.vityuk.com/2011/03/java-formatters-best-practices.html#1" target="_blank" rel="external">1</a> example is straightforward and preferable, unless you undesrstand that you’ll win from reusing instance - then you should go with <a href="http://blog.vityuk.com/2011/03/java-formatters-best-practices.html#4" target="_blank" rel="external">4</a>. These advices applicable for any not thread-safe classes, so you can use them as patterns. But for your classes prefer immutability, which is naturally thread-safe.</p>
  
	</div>
		<footer class="article-footer clearfix">


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Java/">Java</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://yoursite.com/2015/02/04/java-formatters-best-practices/" data-title="Java Formatters Best Practices | louis.chen" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/03/02/getbackstackentrycount-e5-92-8cpopbackstackstring-name-int-flags-e6-96-b9-e6-b3-95/" title="getBackStackEntryCount()和popBackStack(String name, int flags)方法">
  <strong>PREVIOUS:</strong><br/>
  <span>
  getBackStackEntryCount()和popBackStack(String name, int flags)方法</span>
</a>
</div>


<div class="next">
<a href="/2015/02/02/displaying-bitmap-e5-b0-8f-e7-bb-93/"  title="Displaying Bitmap小结">
 <strong>NEXT:</strong><br/> 
 <span>Displaying Bitmap小结
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-_Local_format"><span class="toc-number">1.</span> <span class="toc-text">1. Local format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-_Shared_not_synchronized_format"><span class="toc-number">2.</span> <span class="toc-text">2. Shared not synchronized format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-_Shared_synchronized_format"><span class="toc-number">3.</span> <span class="toc-text">3. Shared synchronized format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-_Shared_thread_local_format"><span class="toc-number">4.</span> <span class="toc-text">4. Shared thread local format</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android开发/" title="Android开发">Android开发<sup>21</sup></a></li>
		
			<li><a href="/categories/Android开源框架/" title="Android开源框架">Android开源框架<sup>4</sup></a></li>
		
			<li><a href="/categories/Android开发/Dandelion/" title="Dandelion">Dandelion<sup>1</sup></a></li>
		
			<li><a href="/categories/Java/" title="Java">Java<sup>1</sup></a></li>
		
			<li><a href="/categories/Android开发/Training文档/" title="Training文档">Training文档<sup>9</sup></a></li>
		
			<li><a href="/categories/Training文档/" title="Training文档">Training文档<sup>9</sup></a></li>
		
			<li><a href="/categories/blog/" title="blog">blog<sup>1</sup></a></li>
		
			<li><a href="/categories/未分类/" title="未分类">未分类<sup>0</sup></a></li>
		
			<li><a href="/categories/自定义控件/" title="自定义控件">自定义控件<sup>4</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/博客/" title="博客">博客<sup>1</sup></a></li>
		
			<li><a href="/tags/文章/" title="文章">文章<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> louis.chen,student of USTC,Focus on mobile develop. <br/>
			It is my amibition to develop beautiful app.</p>
	</section>
	 
	<div class="social-font clearfix">
		
		<a href="http://weibo.com/2338582935" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/leerduo" target="_blank" title="github"></a>
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://yoursite.com" target="_blank" title="louis.chen">louis.chen</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"null"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
